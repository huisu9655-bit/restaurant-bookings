<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>网红预约与流量后台</title>
    <style>
      :root {
        color-scheme: light;
        font-family: 'Inter', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        --bg: #e7eeff;
        --card: #f9fbff;
        --border: #cfdcff;
        --primary: #1348a5;
        --primary-soft: #d1defd;
        --text: #0b1f46;
        --muted: #5c6f93;
        --accent: #1f64ff;
        --danger: #dc2626;
        --nav-bg: #0b2e68;
        --nav-bg-2: #0a3a82;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 20% 20%, #d9e5ff 0, #e7eeff 38%, #f5f8ff 100%);
        color: var(--text);
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }

      .hint {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .hint.error {
        color: var(--danger);
      }

      .file-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }

      .file-item {
        display: grid;
        grid-template-columns: 1fr;
        align-items: center;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.85);
        position: relative;
        cursor: pointer;
      }

      .file-item .file-name {
        font-size: 0.9rem;
        color: var(--text);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .file-item .file-sub {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 2px;
      }

      .file-item:hover {
        border-color: rgba(31, 100, 255, 0.35);
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08);
      }

      .file-item .file-close {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 26px;
        height: 26px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.18);
        background: rgba(255, 255, 255, 0.95);
        color: var(--text);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        line-height: 1;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      }

      .file-item .file-close:hover {
        border-color: rgba(220, 38, 38, 0.35);
        color: var(--danger);
      }

      .avatar-preview {
        width: 100%;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
      }

      .avatar-thumb-wrap {
        position: relative;
        width: 140px;
        aspect-ratio: 2.6 / 1.3;
      }

      .avatar-preview-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: #eef3ff;
      }

      .avatar-thumb-close {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 26px;
        height: 26px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.18);
        background: rgba(255, 255, 255, 0.95);
        color: var(--text);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        line-height: 1;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      }

      .avatar-thumb-close:hover {
        border-color: rgba(220, 38, 38, 0.35);
        color: var(--danger);
      }

      .hidden {
        display: none !important;
      }

      .auth-screen {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(145deg, #0b2e68 0%, #184c9f 60%, #1f64ff 100%);
        padding: 32px 16px;
      }

      .auth-card {
        width: min(420px, 100%);
        background: linear-gradient(160deg, #f9fbff, #eaf1ff);
        border-radius: 28px;
        border: 1px solid var(--border);
        padding: 32px;
        box-shadow: 0 24px 80px rgba(19, 72, 165, 0.25);
      }

      .auth-card h1 {
        margin: 0 0 8px;
        font-size: 1.8rem;
      }

      .auth-card p {
        margin: 0 0 24px;
        color: var(--muted);
      }

      .app-shell {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        min-height: 100vh;
      }

      .sidebar {
        background: linear-gradient(180deg, var(--nav-bg) 0%, var(--nav-bg-2) 60%, #0a2657 100%);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        padding: 32px 20px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        color: #e8f1ff;
      }

      .sidebar h2 {
        margin: 0;
        font-size: 1.2rem;
        color: #f3f6ff;
      }

      .sidebar .hint {
        color: #cbd9ff;
      }

      .menu {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .menu button {
        border: none;
        background: transparent;
        border-radius: 12px;
        padding: 10px 14px;
        text-align: left;
        font-size: 0.95rem;
        color: #d8e3ff;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
      }

      .menu button.active {
        background: rgba(255, 255, 255, 0.12);
        color: #ffffff;
        transform: translateX(4px);
      }

      .menu button:hover {
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
      }

      .logout-btn {
        margin-top: auto;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.08);
        color: #e8f1ff;
        border-radius: 12px;
        padding: 10px 14px;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.16);
        border-color: rgba(255, 255, 255, 0.5);
      }

      main {
        padding: 32px 40px 48px;
        overflow-y: auto;
      }

      .main-header {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 24px;
      }

      .main-header h1 {
        margin: 0;
        font-size: 1.8rem;
      }

      .view {
        display: none;
        flex-direction: column;
        gap: 24px;
      }

      .view.active {
        display: flex;
      }

      .panel {
        background: linear-gradient(160deg, #ffffff 0%, #f2f6ff 60%, #e7eeff 100%);
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 24px;
        box-shadow: 0 10px 40px rgba(15, 35, 82, 0.08);
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
      }

      .panel-header h3 {
        margin: 0;
        font-size: 1.2rem;
      }

      .panel-header p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .grid-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .stat-card {
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 16px;
        background: linear-gradient(135deg, #f8fbff, #e4edff);
      }

      .stat-card h4 {
        margin: 0;
        font-size: 0.95rem;
        color: var(--muted);
      }

      .stat-card strong {
        display: block;
        margin-top: 6px;
        font-size: 1.8rem;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      label {
        font-size: 0.85rem;
        color: var(--muted);
      }

      input,
      select,
      textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font-size: 0.95rem;
        background: #fff;
        text-align: left;
      }

      input[type='search'] {
        text-align: left;
      }

      .input-error {
        border-color: rgba(220, 38, 38, 0.55) !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12);
      }

      .field-alert {
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(220, 38, 38, 0.28);
        background: rgba(220, 38, 38, 0.08);
        color: var(--danger);
        font-size: 0.9rem;
        line-height: 1.35;
      }

      textarea {
        resize: vertical;
        min-height: 90px;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }

      .primary-btn {
        border: none;
        background: var(--accent);
        color: #fff;
        border-radius: 12px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
      }

      .ghost-btn {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        border-radius: 12px;
        padding: 8px 12px;
        cursor: pointer;
      }

      .ghost-btn.sm {
        padding: 6px 10px;
        font-size: 0.85rem;
      }

      .icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease;
        padding: 0;
      }

      .icon-btn svg {
        width: 16px;
        height: 16px;
        stroke: var(--text);
      }

      .icon-btn:hover {
        background: var(--primary-soft);
        border-color: var(--accent);
      }

      .danger-btn {
        border: 1px solid rgba(220, 38, 38, 0.3);
        color: var(--danger);
      }

      .card-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
        margin-top: 12px;
      }

      .inf-card {
        position: relative;
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 18px;
        background: linear-gradient(160deg, #ffffff, #eef3ff);
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
        min-height: 260px;
        box-shadow: 0 12px 32px rgba(13, 41, 96, 0.08);
        padding-bottom: 64px;
      }

      .store-card {
        min-height: auto;
        flex-direction: row;
        align-items: center;
        gap: 12px;
        position: relative;
      }

      .inf-avatar {
        width: 260px;
        height: 128px;
        border-radius: 16px;
        background: #fff;
        flex-shrink: 0;
        object-fit: contain;
        object-position: center;
        display: block;
      }

      .inf-avatar-large {
        width: 260px;
        height: 128px;
        border-radius: 16px;
        background: #fff;
        object-fit: contain;
        object-position: center;
        margin: 0;
        border: 1px solid var(--border);
        display: block;
      }

      .inf-actions {
        position: absolute;
        bottom: 12px;
        right: 12px;
        display: flex;
        gap: 8px;
      }

      .store-card .inf-avatar {
        width: 120px;
        height: 105px;
        object-fit: contain;
        object-position: center;
      }

      .inf-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
      }

      .panel-header-left {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .inline-search {
        display: flex;
        align-items: center;
        width: 100%;
        max-width: 320px;
        min-width: 160px;
        margin-left: 0;
      }

      .inline-sort {
        width: 180px;
        max-width: 220px;
      }

      .th-sort {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }

      .sort-mini {
        width: 20px;
        height: 22px;
        border-radius: 6px;
        border: 1px solid rgba(15, 23, 42, 0.18);
        background: rgba(255, 255, 255, 0.85);
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
      }

      .sort-mini:hover {
        border-color: rgba(31, 100, 255, 0.35);
        background: rgba(219, 234, 254, 0.55);
      }

      .sort-mini .tri {
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        opacity: 0.8;
      }

      .sort-mini .tri.up {
        border-bottom: 7px solid rgba(100, 116, 139, 0.9);
      }

      .sort-mini .tri.down {
        border-top: 7px solid rgba(100, 116, 139, 0.9);
      }

      .sort-mini.active.asc .tri.up {
        border-bottom-color: rgba(31, 100, 255, 0.95);
        opacity: 1;
      }

      .sort-mini.active.asc .tri.down {
        opacity: 0.45;
      }

      .sort-mini.active.desc .tri.down {
        border-top-color: rgba(31, 100, 255, 0.95);
        opacity: 1;
      }

      .sort-mini.active.desc .tri.up {
        opacity: 0.45;
      }

      .panel-header-left label {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        font-size: 1.05rem;
        font-weight: 600;
        flex: 1;
        min-width: 0;
      }

      .inf-filter-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: nowrap;
        width: 100%;
        margin-top: 4px;
      }

      .inf-header-actions {
        align-self: flex-start;
        display: flex;
        gap: 8px;
      }

      .inf-search-label {
        flex: 1;
        min-width: 0;
      }

      .inf-search-text {
        white-space: nowrap;
      }

      .pagination {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 12px 0;
        justify-content: flex-start;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 2px;
      }

      .pager-left,
      .pager-pages,
      .pager-jump {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pager-pages {
        gap: 6px;
        flex-wrap: wrap;
        margin-left: auto;
      }

      .pager-nav,
      .pager-page {
        height: 34px;
        min-width: 34px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid transparent;
        background: #eef2f7;
        color: var(--text);
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        line-height: 1;
      }

      .pager-nav {
        background: #fff;
        border-color: var(--border);
      }

      .pager-page.active {
        background: var(--accent);
        color: #fff;
      }

      .pager-nav:disabled,
      .pager-page:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pager-nav:hover:not(:disabled),
      .pager-page:hover:not(:disabled) {
        background: var(--primary-soft);
        border-color: var(--accent);
      }

      .pager-page.active:hover:not(:disabled) {
        background: #1656e6;
        border-color: #1656e6;
      }

      .pager-ellipsis {
        min-width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        user-select: none;
      }

      .pager-size-select {
        width: auto;
        min-width: 110px;
        padding: 6px 10px;
        border-radius: 10px;
        background: #fff;
      }

      .pager-jump-input {
        width: 72px;
        padding: 6px 10px;
        border-radius: 10px;
      }

      @media (max-width: 760px) {
        .pagination {
          flex-wrap: wrap;
          overflow-x: visible;
        }

        .pager-pages {
          margin-left: 0;
        }
      }

      .inf-card h4 {
        margin: 0;
        font-size: 1rem;
      }

      .inf-card p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 0.85rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }

      .table-wrapper {
        overflow-x: auto;
      }

      th,
      td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      th {
        color: var(--muted);
        font-weight: 500;
      }

      .overview-person {
        display: inline-flex;
        align-items: center;
        gap: 12px;
      }

      .overview-avatar {
        width: 52px;
        height: 26px;
        border-radius: 10px;
        object-fit: cover;
        border: 1px solid var(--border);
        background: #fff;
      }

      .overview-avatar.clickable {
        cursor: zoom-in;
      }

      .image-preview-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 16px;
        z-index: 30;
      }

      .image-preview-card {
        width: min(960px, 100%);
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: 0 24px 80px rgba(15, 23, 42, 0.25);
        overflow: hidden;
      }

      .image-preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(160deg, #ffffff 0%, #f2f6ff 60%, #e7eeff 100%);
      }

      .image-preview-header span {
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
      }

      .image-preview-body {
        background: #0b1220;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 12px;
      }

      .image-preview-body img {
        max-width: 100%;
        max-height: min(72vh, 720px);
        object-fit: contain;
        background: #0b1220;
      }

      .cell-sub {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .influencer-card .cell-sub {
        overflow-wrap: anywhere;
        word-break: break-word;
      }

      .influencer-card .cell-sub a {
        overflow-wrap: anywhere;
        word-break: break-all;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      .overview-traffic-filters {
        display: grid;
        grid-template-columns: 180px minmax(220px, 1fr);
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .overview-traffic-filters .inline-search {
        width: 100%;
        max-width: 360px;
      }

      .overview-traffic-filters select {
        width: 180px;
        max-width: 240px;
      }

      @media (max-width: 560px) {
        .overview-traffic-filters {
          grid-template-columns: 1fr;
        }

        .overview-traffic-filters select {
          width: 100%;
          max-width: none;
        }

        .overview-traffic-filters .inline-search {
          max-width: none;
        }
      }

      .date-large {
        padding: 8px;
        font-size: 1rem;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
      }

      .tag.schedule {
        background: #dbeafe;
        color: var(--accent);
      }

      .tag.walkin {
        background: #fee2e2;
        color: #b91c1c;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.35);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 16px;
        z-index: 20;
      }

      .modal-card {
        width: min(500px, 100%);
        background: #fff;
        border-radius: 24px;
        padding: 24px;
        border: 1px solid var(--border);
        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.2);
      }

      .modal-card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      #dataDetailModal {
        width: min(1400px, 96vw);
        max-height: 86vh;
        padding: 18px 18px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow: hidden;
      }

      #influencerModal {
        width: min(920px, 96vw);
        max-height: 86vh;
        overflow: auto;
      }

      #bookingModal {
        width: min(980px, 96vw);
        max-height: 86vh;
        overflow: auto;
      }

      #trafficModal {
        width: min(980px, 96vw);
        max-height: 86vh;
        overflow: auto;
      }

      #trafficModal .traffic-metrics-row {
        grid-template-columns: repeat(5, minmax(140px, 1fr));
      }

      #autoFetch {
        margin-top: 10px;
      }

      @media (max-width: 980px) {
        #trafficModal .traffic-metrics-row {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }

      #dataDetailModal header {
        margin-bottom: 0;
      }

      #dataDetailModal .data-detail-content {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
        padding-right: 2px;
      }

      #dataDetailModal .table-wrapper {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
      }

      #dataDetailModal table {
        min-width: 720px;
        min-width: 100%;
        width: max-content;
      }

      #dataDetailModal th {
        position: sticky;
        top: 0;
        z-index: 1;
        background: linear-gradient(160deg, #ffffff 0%, #f2f6ff 60%, #e7eeff 100%);
      }

      #dataDetailModal tbody tr:nth-child(odd) td {
        background: rgba(15, 23, 42, 0.02);
      }

      #dataDetailModal .data-detail-footer {
        flex: 0 0 auto;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      #dataDetailModal .data-detail-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      @media (max-width: 640px) {
        #dataDetailModal {
          padding: 16px 14px 12px;
          max-height: 88vh;
        }

        #dataDetailModal .data-detail-footer {
          grid-template-columns: 1fr;
        }

        #dataDetailModal .data-detail-actions button {
          width: 100%;
        }
      }

      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--text);
        color: #fff;
        padding: 12px 16px;
        border-radius: 14px;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .lang-switch {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
      }

      .lang-switch select {
        width: auto;
        min-width: 130px;
        padding: 6px 10px;
        border-radius: 10px;
      }

      .sidebar .lang-switch {
        margin-top: 4px;
      }

      .auth-lang {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 10px;
      }

      @media (max-width: 960px) {
        .app-shell {
          grid-template-columns: 1fr;
        }
        .sidebar {
          flex-direction: row;
          flex-wrap: wrap;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <div id="loginScreen" class="auth-screen hidden">
      <div class="auth-card">
        <div class="auth-lang">
          <div class="lang-switch">
            <span class="hint" data-i18n="label.lang">语言</span>
            <select id="langSelectLogin">
              <option value="zh" data-i18n="lang.zh">中文</option>
              <option value="vi" data-i18n="lang.vi">越南语</option>
            </select>
          </div>
        </div>
        <h1 data-i18n="login.title">欢迎登录</h1>
        <p data-i18n="login.subtitle">使用运营账号进入网红预约与流量后台</p>
        <form id="loginForm">
          <div>
            <label for="loginUsername" data-i18n="login.username">账号</label>
            <input id="loginUsername" name="username" placeholder="admin" required />
          </div>
          <div>
            <label for="loginPassword" data-i18n="login.password">密码</label>
            <input id="loginPassword" name="password" type="password" required />
          </div>
          <button class="primary-btn" type="submit" data-i18n="login.submit">登录</button>
        </form>
      </div>
    </div>

    <div id="appShell" class="app-shell hidden">
      <aside class="sidebar">
        <div>
          <h2 data-i18n="sidebar.title">餐厅推广预约投放中心</h2>
          <p id="sidebarUser" class="hint"></p>
          <div class="lang-switch">
            <span class="hint" data-i18n="label.lang">语言</span>
            <select id="langSelect">
              <option value="zh" data-i18n="lang.zh">中文</option>
              <option value="vi" data-i18n="lang.vi">越南语</option>
            </select>
          </div>
        </div>
        <nav class="menu">
          <button data-view="overview" class="active" data-i18n="menu.overview">投放总览</button>
          <button data-view="bookings" data-i18n="menu.bookings">预约与流量</button>
          <button data-view="influencers" data-i18n="menu.influencers">网红管理</button>
          <button data-view="stores" data-i18n="menu.stores">店铺管理</button>
          <button data-view="users" data-i18n="menu.users">用户管理</button>
        </nav>
        <button class="logout-btn" id="logoutBtn" data-i18n="action.logout">退出登录</button>
      </aside>
      <main>
        <header class="main-header">
          <div>
            <h1 id="pageTitle" data-i18n="app.title">网红预约与流量后台</h1>
            <p id="welcomeHint" data-i18n="app.loading">加载中...</p>
          </div>
        </header>

        <section class="view active" id="overviewView">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h3 data-i18n="overview.bookings7d.title">近7天预约情况明细</h3>
                <p data-i18n="overview.bookings7d.subtitle">查看未来7天的预约到访安排</p>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.influencer">达人</th>
                    <th data-i18n="th.contact">联系方式</th>
                    <th data-i18n="th.store">门店</th>
                    <th data-i18n="th.visitTime">到访时间</th>
                  </tr>
                </thead>
                <tbody id="overviewTodayBookings"></tbody>
              </table>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header">
              <div>
                <h3 data-i18n="overview.traffic.title">最新流量列表</h3>
                <p id="overviewTrafficSubtitle">按观看量排序</p>
                <div class="overview-traffic-filters">
                  <select id="overviewTrafficStoreFilter">
                    <option value="all" data-i18n="filter.allStores">全部门店</option>
                  </select>
                  <div class="inline-search">
                    <input
                      type="search"
                      id="overviewTrafficKeyword"
                      placeholder="搜索达人昵称"
                      data-i18n-placeholder="placeholder.searchInfluencer"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.influencer">达人</th>
                    <th data-i18n="th.store">门店</th>
                    <th data-i18n="th.videoLink">视频链接</th>
                    <th>
                      <span class="th-sort">
                        <span data-i18n="th.postDate">视频发布时间</span>
                        <button type="button" class="sort-mini" id="overviewTrafficPostDateSort">
                          <span class="tri up"></span>
                          <span class="tri down"></span>
                        </button>
                      </span>
                    </th>
                    <th data-i18n="th.views">观看</th>
                    <th data-i18n="th.likes">点赞</th>
                    <th data-i18n="th.comments">评论</th>
                    <th data-i18n="th.saves">收藏</th>
                    <th data-i18n="th.shares">分享</th>
                    <th data-i18n="th.updatedAt">最新更新时间</th>
                  </tr>
                </thead>
                <tbody id="overviewTraffic"></tbody>
              </table>
              <div class="pagination" id="overviewTrafficPager"></div>
            </div>
          </div>
        </section>

        <section class="view" id="influencersView">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-header-left">
                <h3 data-i18n="influencers.title">达人档案</h3>
                <p class="hint" style="margin: 0 0 4px;" data-i18n="influencers.subtitle">支持按达人昵称 / 账号搜索</p>
                <div class="inf-filter-row">
                  <div class="inline-search">
                    <input
                      type="search"
                      id="influencerSearch"
                      placeholder="输入达人昵称 / 账号"
                      data-i18n-placeholder="influencers.search.placeholder"
                    />
                  </div>
                </div>
              </div>
              <div class="inf-header-actions">
                <button class="primary-btn" id="openInfModal" data-i18n="influencers.add">新增达人</button>
                <button class="ghost-btn" id="openInfImport" data-i18n="influencers.import">导入达人</button>
              </div>
            </div>
            <div class="card-list" id="influencerCards"></div>
            <div class="pagination" id="infPagination"></div>
          </div>
        </section>

        <section class="view" id="bookingsView">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h3 data-i18n="bookings.title">预约与流量列表</h3>
              </div>
              <button class="primary-btn" id="openBookingModal" data-i18n="bookings.add">新增预约</button>
            </div>
            <p class="hint" style="margin: 0 0 8px;" data-i18n="bookings.subtitle">支持按达人昵称、门店或到访日期筛选</p>
            <div class="filters">
              <input id="bookingKeyword" placeholder="达人昵称" data-i18n-placeholder="bookings.keyword.placeholder" />
              <select id="bookingStoreFilter"></select>
              <input type="date" id="bookingDate" class="date-large" />
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.influencer">达人</th>
                    <th data-i18n="th.store">门店</th>
                    <th data-i18n="th.type">类型</th>
                    <th data-i18n="th.visit">到访</th>
                    <th data-i18n="th.service">服务内容</th>
                    <th data-i18n="th.budget">费用(万)</th>
                    <th data-i18n="th.traffic">流量</th>
                    <th data-i18n="th.actions">操作</th>
                  </tr>
                </thead>
                <tbody id="bookingTable"></tbody>
              </table>
            </div>
            <div class="pagination" id="bookingPagination"></div>
          </div>
        </section>

        <section class="view" id="usersView">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h3 data-i18n="users.title">账号列表</h3>
              </div>
              <button class="primary-btn" id="openUserModal" data-i18n="users.add">新增账号</button>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.username">账号</th>
                    <th data-i18n="th.role">角色</th>
                    <th data-i18n="th.actions">操作</th>
                  </tr>
                </thead>
                <tbody id="userTable"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="view" id="storesView">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h3 data-i18n="stores.title">门店列表</h3>
                <p data-i18n="stores.subtitle">仅保留名称、地址、图片</p>
              </div>
              <button class="primary-btn" id="openStoreModal" data-i18n="stores.add">新增门店</button>
            </div>
            <div class="card-list" id="storeCards"></div>
          </div>
        </section>
      </main>
    </div>

    <div id="imagePreviewBackdrop" class="image-preview-backdrop hidden" aria-hidden="true">
      <div class="image-preview-card" role="dialog" aria-modal="true">
        <div class="image-preview-header">
          <span id="imagePreviewTitle" data-i18n="image.previewTitle">头像预览</span>
          <button class="ghost-btn" type="button" id="closeImagePreview" data-i18n="common.close">关闭</button>
        </div>
        <div class="image-preview-body">
          <img id="imagePreviewImg" alt="" />
        </div>
      </div>
    </div>

    <div id="modalBackdrop" class="modal-backdrop hidden">
      <div class="modal-card hidden" id="influencerModal">
        <header>
          <h3 id="infModalTitle">新增达人</h3>
          <button class="ghost-btn" data-close data-i18n="common.close">关闭</button>
        </header>
        <form id="influencerForm">
          <input type="hidden" id="infId" />
          <input type="hidden" id="infAvatarData" name="avatarData" />
          <input type="hidden" id="infAuditReportName" name="auditReportName" />
          <input type="hidden" id="infAuditReportText" name="auditReportText" />
          <input type="hidden" id="infCommentDetailName" name="commentDetailName" />
          <input type="hidden" id="infCommentDetailText" name="commentDetailText" />
          <div class="form-row">
            <div>
              <label for="infName" data-i18n="label.infNameRequired">达人昵称 *</label>
              <input id="infName" name="displayName" required />
            </div>
            <div>
              <label for="infHandle" data-i18n="label.infHandle">账号</label>
              <input id="infHandle" name="handle" placeholder="@account" />
            </div>
          </div>
          <div class="field-alert hidden" id="infDuplicateAlert" role="alert"></div>
          <div>
            <label for="infProfileLink" data-i18n="label.infProfileLink">达人ID（主页链接）</label>
            <input id="infProfileLink" name="profileLink" placeholder="https://www.tiktok.com/@xxx" />
          </div>
          <div class="form-row">
            <div>
              <label for="infPhoto" data-i18n="label.infPhoto">照片</label>
              <input type="file" id="infPhoto" accept="image/*" />
              <div class="hint" data-i18n="hint.imageToData">支持 jpg/png，自动转为数据存储</div>
            </div>
            <div>
              <label data-i18n="influencers.avatarPreview">照片预览</label>
              <div class="avatar-preview">
                <div class="avatar-thumb-wrap">
                  <img id="infAvatarPreviewImg" class="avatar-preview-img" alt="" />
                  <button
                    type="button"
                    id="infAvatarClearBtn"
                    class="avatar-thumb-close hidden"
                    data-i18n-title="influencers.avatarDelete"
                    aria-label="删除照片"
                    title="删除照片"
                  >
                    ×
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="infAuditReportFile" data-i18n="label.auditReport">审计报告（CSV/JSON）</label>
              <input
                type="file"
                id="infAuditReportFile"
                multiple
                accept=".csv,.tsv,.txt,.json,text/csv,text/plain,application/json"
              />
              <div class="hint" id="infAuditReportMeta"></div>
              <div class="file-list" id="infAuditReportList"></div>
            </div>
            <div>
              <label for="infCommentDetailFile" data-i18n="label.commentDetail">评论详情（CSV/JSON）</label>
              <input
                type="file"
                id="infCommentDetailFile"
                multiple
                accept=".csv,.tsv,.txt,.json,text/csv,text/plain,application/json"
              />
              <div class="hint" id="infCommentDetailMeta"></div>
              <div class="file-list" id="infCommentDetailList"></div>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="infContactMethod" data-i18n="label.infContactMethod">联系渠道</label>
              <input
                id="infContactMethod"
                name="contactMethod"
                placeholder="Zalo / WhatsApp"
                data-i18n-placeholder="placeholder.contactMethod"
              />
            </div>
            <div>
              <label for="infContactInfo" data-i18n="label.infContactInfo">联系方式</label>
              <input id="infContactInfo" name="contactInfo" />
            </div>
          </div>
          <div>
            <label for="infNotes" data-i18n="label.notes">备注</label>
            <textarea id="infNotes" name="notes"></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="primary-btn" id="infSubmit" data-i18n="modal.influencer.submit">保存达人</button>
            <button type="button" class="ghost-btn" data-close data-i18n="common.cancel">取消</button>
          </div>
        </form>
      </div>
      <div class="modal-card hidden" id="bookingModal">
        <header>
          <h3 id="bookingModalTitle">新增预约</h3>
          <button class="ghost-btn" data-close data-i18n="common.close">关闭</button>
        </header>
        <form id="bookingForm">
          <div class="form-row">
            <div>
              <label for="modalStore" data-i18n="label.storeRequired">门店 *</label>
              <select id="modalStore" name="storeId" required></select>
            </div>
            <div>
              <label for="modalInfluencerSearch" data-i18n="label.influencerRequired">达人 *</label>
              <input
                id="modalInfluencerSearch"
                name="influencerSearch"
                list="modalInfluencerList"
                placeholder="输入达人昵称或账号，例如：ng.hamii / @ng.hamii"
                data-i18n-placeholder="placeholder.influencerSearch"
                autocomplete="off"
                required
              />
              <input type="hidden" id="modalInfluencer" name="influencerId" />
              <datalist id="modalInfluencerList"></datalist>
              <div class="field-alert hidden" id="modalInfluencerAlert" role="alert"></div>
              <div class="hint" style="margin-top: 4px;" data-i18n="booking.influencerHint">选择下拉匹配项后会自动填充达人</div>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="modalSource" data-i18n="label.source">来源</label>
              <select id="modalSource" name="sourceType">
                <option value="预约" data-i18n="source.scheduled">预约</option>
                <option value="自来" data-i18n="source.walkin">自来</option>
              </select>
            </div>
            <div>
              <label for="modalVisitDate" data-i18n="label.visitDateRequired">到访日期 *</label>
              <input type="date" id="modalVisitDate" name="visitDate" required />
            </div>
            <div>
              <label for="modalVisitWindow" data-i18n="label.visitWindow">到访时段</label>
              <input id="modalVisitWindow" name="visitWindow" />
            </div>
          </div>
          <div>
            <label for="modalService" data-i18n="label.serviceDetail">服务内容 </label>
            <textarea id="modalService" name="serviceDetail"></textarea>
          </div>
          <div class="form-row">
            <div>
              <label for="modalRights" data-i18n="label.videoRights">备注/脚本要求</label>
              <input id="modalRights" name="videoRights" />
            </div>
            <div>
              <label for="modalBudget" data-i18n="label.budget">费用 (万 VND)</label>
              <input type="number" id="modalBudget" name="budgetMillionVND" min="0" step="5" />
            </div>
            <div>
              <label for="modalPostDate" data-i18n="label.postDateExpected">预计发布时间</label>
              <input type="date" id="modalPostDate" name="postDate" />
            </div>
          </div>
          <div>
            <label for="modalNotes" data-i18n="label.notes">备注</label>
            <textarea id="modalNotes" name="notes"></textarea>
          </div>
          <button class="primary-btn" type="submit" id="bookingSubmit" data-i18n="modal.booking.submit">提交预约</button>
        </form>
      </div>

      <div class="modal-card hidden" id="trafficModal">
        <header>
          <h3 data-i18n="modal.traffic.title">登记流量</h3>
          <button class="ghost-btn" data-close data-i18n="common.close">关闭</button>
        </header>
        <form id="trafficForm">
          <input type="hidden" name="bookingId" id="trafficBookingId" />
          <input type="hidden" name="trafficId" id="trafficId" />
          <div>
            <label for="trafficVideo" data-i18n="label.videoLinkRequired">视频链接 *</label>
            <input id="trafficVideo" name="videoLink" required />
          </div>
          <div>
            <label for="trafficPostDate" data-i18n="label.videoPostDate">视频发布时间</label>
            <input type="date" id="trafficPostDate" name="postDate" />
          </div>
          <div class="form-row traffic-metrics-row">
            <div>
              <label for="trafficViews" data-i18n="label.views">观看</label>
              <input type="number" id="trafficViews" name="views" min="0" />
            </div>
            <div>
              <label for="trafficLikes" data-i18n="label.likes">点赞</label>
              <input type="number" id="trafficLikes" name="likes" min="0" />
            </div>
            <div>
              <label for="trafficComments" data-i18n="label.comments">评论</label>
              <input type="number" id="trafficComments" name="comments" min="0" />
            </div>
            <div>
              <label for="trafficSaves" data-i18n="label.saves">收藏</label>
              <input type="number" id="trafficSaves" name="saves" min="0" />
            </div>
            <div>
              <label for="trafficShares" data-i18n="label.shares">分享</label>
              <input type="number" id="trafficShares" name="shares" min="0" />
            </div>
          </div>
          <div>
            <label for="trafficNote" data-i18n="label.notes">备注</label>
            <textarea id="trafficNote" name="note"></textarea>
          </div>
          <button class="primary-btn" type="submit" data-i18n="modal.traffic.submit">提交流量</button>
        </form>
        <button class="ghost-btn" id="autoFetch" data-i18n="modal.traffic.autofetch">尝试自动抓取</button>
      </div>
      <div class="modal-card hidden" id="infImportModal">
        <header>
          <h3 data-i18n="modal.import.title">导入达人</h3>
          <button class="ghost-btn" data-close data-i18n="common.close">关闭</button>
        </header>
        <p class="hint" style="margin: 0 0 12px;" data-i18n="modal.import.hint">
          上传 CSV（不含照片），字段顺序：达人昵称,账号,联系渠道,联系方式,备注
        </p>
        <form id="infImportForm">
          <div class="form-row">
            <div>
              <label for="infImportFile" data-i18n="modal.import.choose">选择 CSV</label>
              <input type="file" id="infImportFile" accept=".csv,text/csv" required />
            </div>
            <div>
              <label>&nbsp;</label>
              <a id="infTemplateLink" class="hint" download="influencers_template.csv" data-i18n="modal.import.template">下载模板</a>
            </div>
          </div>
          <button class="primary-btn" type="submit" data-i18n="modal.import.submit">开始导入</button>
        </form>
      </div>
      <div class="modal-card hidden" id="storeModal">
        <header>
          <h3 id="storeModalTitle">新增门店</h3>
          <button class="ghost-btn" data-close data-i18n="common.close">关闭</button>
        </header>
        <form id="storeForm">
          <input type="hidden" id="storeImageData" name="imageData" />
          <div>
            <label for="storeName" data-i18n="label.storeNameRequired">门店名称 *</label>
            <input id="storeName" name="name" required />
          </div>
          <div>
            <label for="storeAddress" data-i18n="label.address">地址</label>
            <input id="storeAddress" name="address" />
          </div>
          <div class="form-row">
            <div>
              <label for="storePhoto" data-i18n="label.storePhoto">门店图片</label>
              <input type="file" id="storePhoto" accept="image/*" />
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="hint" data-i18n="hint.storeImageToData">图片将转为 base64 存储，用于卡片展示</div>
            </div>
          </div>
          <div class="form-actions">
            <button class="primary-btn" type="submit" id="storeSubmit" data-i18n="modal.store.submit">保存门店</button>
            <button class="ghost-btn" type="button" id="storeReset" data-close data-i18n="common.cancel">取消</button>
          </div>
        </form>
      </div>
      <div class="modal-card hidden" id="userModal">
        <header>
          <h3 data-i18n="modal.user.title">新增账号</h3>
          <button class="ghost-btn" data-close data-i18n="common.close">关闭</button>
        </header>
        <form id="userForm">
          <div class="form-row">
            <div>
              <label for="userName" data-i18n="label.userNameRequired">账号 *</label>
              <input id="userName" name="username" required />
            </div>
            <div>
              <label for="userPassword" data-i18n="label.userPasswordRequired">密码 *</label>
              <input id="userPassword" name="password" type="password" required />
            </div>
          </div>
          <button class="primary-btn" type="submit" data-i18n="modal.user.submit">创建账号</button>
        </form>
      </div>

      <div class="modal-card hidden" id="dataDetailModal">
        <header>
          <h3 id="dataDetailTitle" data-i18n="dataDetail.title">数据详情</h3>
          <button class="ghost-btn" data-close data-i18n="common.close">关闭</button>
        </header>
        <div class="data-detail-content">
          <div class="form-row hidden" id="dataDetailFileRow" style="margin-bottom: 8px;">
            <div>
              <label class="hint" for="dataDetailFileSelect" data-i18n="dataDetail.fileSelect">选择文件</label>
              <select id="dataDetailFileSelect"></select>
            </div>
          </div>
          <div class="hint" id="dataDetailMeta" style="margin: 0 0 10px;"></div>
          <div class="form-row" style="margin-bottom: 10px;">
            <div class="inline-search" style="max-width: none;">
              <input
                type="search"
                id="dataDetailSearch"
                placeholder="搜索..."
                data-i18n-placeholder="dataDetail.search.placeholder"
              />
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead id="dataDetailHead"></thead>
              <tbody id="dataDetailBody"></tbody>
            </table>
          </div>
        </div>
        <div class="data-detail-footer">
          <div class="pagination" id="dataDetailPager"></div>
          <div class="data-detail-actions">
            <button class="primary-btn" type="button" data-close data-i18n="common.close">关闭</button>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const savedUser = (() => {
        try {
          return JSON.parse(localStorage.getItem('booking_user') || 'null');
        } catch (error) {
          return null;
        }
      })();
      const state = {
        token: localStorage.getItem('booking_token') || '',
        user: savedUser,
        lang: localStorage.getItem('booking_lang') || 'zh',
        stores: [],
        influencers: [],
        bookings: [],
        trafficLogs: [],
        overview: null,
        lastCreatedInfluencerId: localStorage.getItem('booking_lastCreatedInfluencerId') || '',
        lastCreatedInfluencerAt: Number(localStorage.getItem('booking_lastCreatedInfluencerAt') || '0') || 0,
        influencerFiles: { audit: [], comment: [] },
        pendingInfluencerFiles: { audit: [], comment: [] },
        overviewTrafficPage: 1,
        overviewTrafficPageSize: 10,
        overviewTrafficSort: { field: 'views', dir: 'desc' },
        overviewTrafficFilters: {
          store: 'all',
          q: ''
        },
        users: [],
        editingStoreId: '',
        editingInfluencerId: '',
        editingBookingId: '',
        infPage: 1,
        infRowsPerPage: 2,
        bookingPage: 1,
        bookingPageSize: 10,
        currentView: 'overview',
        _justCreatedInfluencerId: '',
        filters: {
          q: '',
          store: '',
          date: ''
        },
        dataDetail: {
          title: '',
          fileName: '',
          columns: [],
          rows: [],
          page: 1,
          pageSize: 20,
          search: '',
          fileOptions: [],
          selectedFileId: '',
          sourceInfluencerId: '',
          sourceKind: ''
        }
      };

      const i18n = {
        zh: {
          'label.lang': '语言',
          'lang.zh': '中文',
          'lang.vi': '越南语',
          'login.title': '欢迎登录',
          'login.subtitle': '使用运营账号进入网红预约与流量后台',
          'login.username': '账号',
          'login.password': '密码',
          'login.submit': '登录',
          'sidebar.title': '餐厅推广预约投放中心',
          'menu.overview': '投放总览',
          'menu.bookings': '预约与流量',
          'menu.influencers': '网红管理',
          'menu.stores': '店铺管理',
          'menu.users': '用户管理',
          'action.logout': '退出登录',
          'app.title': '网红预约与流量后台',
          'app.loading': '加载中...',
          'overview.bookings7d.title': '近7天预约情况明细',
          'overview.bookings7d.subtitle': '查看未来7天的预约到访安排',
          'overview.traffic.title': '最新流量列表',
          'overview.traffic.subtitle.views': '按观看量排序',
          'overview.traffic.subtitle.postDateAsc': '按视频发布时间（升序）',
          'overview.traffic.subtitle.postDateDesc': '按视频发布时间（降序）',
          'sort.toAsc': '点击升序',
          'sort.toDesc': '点击降序',
          'sort.clear': '取消排序',
          'placeholder.searchInfluencer': '搜索达人昵称',
          'th.influencer': '达人',
          'th.contact': '联系方式',
          'th.store': '门店',
          'th.visitTime': '到访时间',
          'th.videoLink': '视频链接',
          'th.postDate': '视频发布时间',
          'th.views': '观看',
          'th.likes': '点赞',
          'th.comments': '评论',
          'th.saves': '收藏',
          'th.shares': '分享',
          'th.updatedAt': '最新更新时间',
          'th.type': '类型',
          'th.visit': '到访',
          'th.service': '服务内容',
          'th.budget': '费用(万)',
          'th.traffic': '流量',
          'th.actions': '操作',
          'th.username': '账号',
          'th.role': '角色',
          'influencers.title': '达人档案',
          'influencers.subtitle': '支持按达人昵称 / 账号搜索',
          'influencers.search.placeholder': '输入达人昵称 / 账号',
          'influencers.add': '新增达人',
          'influencers.import': '导入达人',
          'bookings.title': '预约与流量列表',
          'bookings.add': '新增预约',
          'bookings.subtitle': '支持按达人昵称、门店或到访日期筛选',
          'bookings.keyword.placeholder': '达人昵称',
          'booking.influencerHint': '选择下拉匹配项后会自动填充达人',
          'booking.influencerNotFound': '系统内未找到该达人，请先去【网红管理】新增达人后再选择',
          'users.title': '账号列表',
          'users.add': '新增账号',
          'stores.title': '门店列表',
          'stores.subtitle': '仅保留名称、地址、图片',
          'stores.add': '新增门店',
          'modal.booking.addTitle': '新增预约',
          'modal.booking.editTitle': '编辑预约',
          'modal.booking.submit': '提交预约',
          'modal.booking.save': '保存修改',
          'modal.store.addTitle': '新增门店',
          'modal.store.editTitle': '编辑门店',
          'modal.store.submit': '保存门店',
          'modal.store.save': '保存更新',
          'modal.influencer.addTitle': '新增达人',
          'modal.influencer.editTitle': '编辑达人',
          'modal.influencer.submit': '保存达人',
          'modal.influencer.save': '保存修改',
          'label.infNameRequired': '达人昵称 *',
          'label.infHandle': '账号',
          'label.infProfileLink': '达人ID（主页链接）',
          'label.infPhoto': '照片',
          'label.auditReport': '审计报告（CSV/JSON）',
          'label.commentDetail': '评论详情（CSV/JSON）',
          'hint.imageToData': '支持 jpg/png，自动转为数据存储',
          'label.infContactMethod': '联系渠道',
          'placeholder.contactMethod': 'Zalo / WhatsApp',
          'label.infContactInfo': '联系方式',
          'label.notes': '备注',
          'label.storeRequired': '门店 *',
          'label.influencerRequired': '达人 *',
          'placeholder.influencerSearch': '输入达人昵称或账号，例如：ng.hamii / @ng.hamii',
          'label.source': '来源',
          'label.visitDateRequired': '到访日期 *',
          'label.visitWindow': '到访时段',
          'label.serviceDetail': '服务内容',
          'label.videoRights': '备注/脚本要求',
          'label.budget': '费用 (万 VND)',
          'label.postDateExpected': '预计发布时间',
          'modal.traffic.title': '登记流量',
          'modal.traffic.submit': '提交流量',
          'modal.traffic.autofetch': '尝试自动抓取',
          'label.videoPostDate': '视频发布时间',
          'label.videoLinkRequired': '视频链接 *',
          'label.views': '观看',
          'label.likes': '点赞',
          'label.comments': '评论',
          'label.saves': '收藏',
          'label.shares': '分享',
          'modal.import.title': '导入达人',
          'modal.import.hint': '上传 CSV（不含照片），字段顺序：达人昵称,账号,联系渠道,联系方式,备注',
          'modal.import.choose': '选择 CSV',
          'modal.import.template': '下载模板',
          'modal.import.submit': '开始导入',
          'label.storeNameRequired': '门店名称 *',
          'label.address': '地址',
          'label.storePhoto': '门店图片',
          'hint.storeImageToData': '图片将转为 base64 存储，用于卡片展示',
          'modal.user.title': '新增账号',
          'modal.user.submit': '创建账号',
          'label.userNameRequired': '账号 *',
          'label.userPasswordRequired': '密码 *',
          'filter.allStores': '全部门店',
          'source.scheduled': '预约',
          'source.walkin': '自来',
          'common.na': '—',
          'common.pending': '待定',
          'common.unnamed': '未命名',
          'common.view': '查看',
          'common.edit': '编辑',
          'common.delete': '删除',
          'common.close': '关闭',
          'common.cancel': '取消',
          'common.noData': '暂无数据',
          'common.and': '和',
          'overview.bookings7d.empty': '近7天暂无预约',
          'image.previewTitle': '头像预览',
          'influencers.profileLinkLabel': '达人ID：',
          'influencers.auditReportLabel': '审计报告：',
          'influencers.commentDetailLabel': '评论详情：',
          'influencers.avatarPreview': '照片预览',
          'influencers.avatarDelete': '删除照片',
          'influencers.contactMissing': '联系方式未填写',
          'influencers.duplicateBase': '该达人{fields}已存在，无需重复新增',
          'influencers.duplicateMatched': '（已存在：{name}{handle}）',
          'field.displayName': '昵称',
          'field.handle': '账号',
          'dataDetail.title': '数据详情',
          'dataDetail.fileSelect': '选择文件',
          'dataDetail.search.placeholder': '搜索（支持全字段）',
          'dataDetail.meta': '文件：{file} · {count} 行',
          'influencerFiles.count': '已上传 {n} 个文件',
          'influencerFiles.empty': '暂无上传文件（可选择多个）',
          'influencerFiles.pending': '待上传',
          'influencerFiles.confirmDelete': '确认删除该文件？',
          'influencerFiles.deleted': '文件已删除',
          'influencerFiles.uploaded': '文件已上传',
          'influencerFiles.uploading': '正在上传附件...',
          'upload.tooLarge': '文件过大，请选择小于 {max}MB 的文件',
          'upload.readFailed': '读取文件失败',
          'upload.parseFailed': '文件解析失败，请确认格式为 CSV/TSV/JSON',
          'upload.excelNotSupported': '暂不支持 Excel 文件，请先另存为 CSV 或导出为 JSON',
          'stores.empty': '暂无门店',
          'stores.addressMissing': '地址待补充',
          'bookings.empty': '暂无预约',
          'bookings.trafficAdd': '登记流量',
          'traffic.none': '未登记',
          'traffic.summary': '{views} 观看 · {date}',
          'users.empty': '暂无账号',
          'users.resetPassword': '重置密码',
          'pager.total': '共 {count} 条',
          'pager.goto': '前往',
          'pager.page': '页',
          'pager.perPage': '{n}条/页',
          'pager.prev': '‹',
          'pager.next': '›',
          'confirm.deleteInfluencer': '确认删除该达人？如果存在关联预约或流量将无法删除。',
          'confirm.deleteBooking': '确认删除该预约？相关流量记录也会被删除。',
          'confirm.deleteStore': '确认删除该门店？如有预约将无法删除。',
          'toast.influencerDeleted': '达人已删除',
          'toast.bookingDeleted': '预约已删除',
          'toast.storeDeleted': '门店已删除'
        },
        vi: {
          'label.lang': 'Ngôn ngữ',
          'lang.zh': '中文',
          'lang.vi': 'Tiếng Việt',
          'login.title': 'Chào mừng đăng nhập',
          'login.subtitle': 'Dùng tài khoản vận hành để vào hệ thống đặt lịch & traffic KOC',
          'login.username': 'Tài khoản',
          'login.password': 'Mật khẩu',
          'login.submit': 'Đăng nhập',
          'sidebar.title': 'Trung tâm đặt lịch & chạy KOC',
          'menu.overview': 'Tổng quan',
          'menu.bookings': 'Lịch hẹn & traffic',
          'menu.influencers': 'Quản lý KOC',
          'menu.stores': 'Quản lý cửa hàng',
          'menu.users': 'Quản lý tài khoản',
          'action.logout': 'Đăng xuất',
          'app.title': 'Hệ thống đặt lịch & traffic KOC',
          'app.loading': 'Đang tải...',
          'overview.bookings7d.title': 'Lịch hẹn 7 ngày tới',
          'overview.bookings7d.subtitle': 'Xem lịch hẹn trong 7 ngày tới',
          'overview.traffic.title': 'Traffic mới nhất',
          'overview.traffic.subtitle.views': 'Sắp xếp theo lượt xem',
          'overview.traffic.subtitle.postDateAsc': 'Sắp xếp theo ngày đăng (tăng dần)',
          'overview.traffic.subtitle.postDateDesc': 'Sắp xếp theo ngày đăng (giảm dần)',
          'sort.toAsc': 'Bấm để tăng dần',
          'sort.toDesc': 'Bấm để giảm dần',
          'sort.clear': 'Hủy sắp xếp',
          'placeholder.searchInfluencer': 'Tìm theo tên KOC',
          'th.influencer': 'KOC',
          'th.contact': 'Liên hệ',
          'th.store': 'Cửa hàng',
          'th.visitTime': 'Thời gian đến',
          'th.videoLink': 'Link video',
          'th.postDate': 'Ngày đăng',
          'th.views': 'Lượt xem',
          'th.likes': 'Lượt thích',
          'th.comments': 'Bình luận',
          'th.saves': 'Lưu',
          'th.shares': 'Chia sẻ',
          'th.updatedAt': 'Cập nhật lúc',
          'th.type': 'Loại',
          'th.visit': 'Đến',
          'th.service': 'Nội dung',
          'th.budget': 'Chi phí (vạn)',
          'th.traffic': 'Traffic',
          'th.actions': 'Thao tác',
          'th.username': 'Tài khoản',
          'th.role': 'Vai trò',
          'influencers.title': 'Hồ sơ KOC',
          'influencers.subtitle': 'Hỗ trợ tìm theo tên KOC / tài khoản',
          'influencers.search.placeholder': 'Nhập tên KOC / tài khoản',
          'influencers.add': 'Thêm KOC',
          'influencers.import': 'Nhập KOC',
          'bookings.title': 'Danh sách lịch hẹn & traffic',
          'bookings.add': 'Thêm lịch hẹn',
          'bookings.subtitle': 'Lọc theo KOC / cửa hàng / ngày đến',
          'bookings.keyword.placeholder': 'Tên KOC',
          'booking.influencerHint': 'Chọn gợi ý trong danh sách để tự điền KOC',
          'booking.influencerNotFound': 'Không tìm thấy KOC trong hệ thống, hãy vào【Quản lý KOC】để thêm trước rồi chọn lại',
          'users.title': 'Danh sách tài khoản',
          'users.add': 'Thêm tài khoản',
          'stores.title': 'Danh sách cửa hàng',
          'stores.subtitle': 'Chỉ lưu tên, địa chỉ, ảnh',
          'stores.add': 'Thêm cửa hàng',
          'modal.booking.addTitle': 'Thêm lịch hẹn',
          'modal.booking.editTitle': 'Sửa lịch hẹn',
          'modal.booking.submit': 'Tạo lịch hẹn',
          'modal.booking.save': 'Lưu thay đổi',
          'modal.store.addTitle': 'Thêm cửa hàng',
          'modal.store.editTitle': 'Sửa cửa hàng',
          'modal.store.submit': 'Lưu cửa hàng',
          'modal.store.save': 'Lưu cập nhật',
          'modal.influencer.addTitle': 'Thêm KOC',
          'modal.influencer.editTitle': 'Sửa KOC',
          'modal.influencer.submit': 'Lưu KOC',
          'modal.influencer.save': 'Lưu thay đổi',
          'label.infNameRequired': 'Tên KOC *',
          'label.infHandle': 'Tài khoản',
          'label.infProfileLink': 'ID KOC (link trang)',
          'label.infPhoto': 'Ảnh',
          'label.auditReport': 'Báo cáo audit (CSV/JSON)',
          'label.commentDetail': 'Chi tiết bình luận (CSV/JSON)',
          'hint.imageToData': 'Hỗ trợ jpg/png, sẽ lưu dưới dạng dữ liệu',
          'label.infContactMethod': 'Kênh liên hệ',
          'placeholder.contactMethod': 'Zalo / WhatsApp',
          'label.infContactInfo': 'Thông tin liên hệ',
          'label.notes': 'Ghi chú',
          'label.storeRequired': 'Cửa hàng *',
          'label.influencerRequired': 'KOC *',
          'placeholder.influencerSearch': 'Nhập tên KOC hoặc @tài_khoản, ví dụ: ng.hamii / @ng.hamii',
          'label.source': 'Nguồn',
          'label.visitDateRequired': 'Ngày đến *',
          'label.visitWindow': 'Khung giờ',
          'label.serviceDetail': 'Nội dung dịch vụ',
          'label.videoRights': 'Ghi chú/Yêu cầu kịch bản',
          'label.budget': 'Chi phí (vạn VND)',
          'label.postDateExpected': 'Ngày đăng dự kiến',
          'modal.traffic.title': 'Nhập traffic',
          'modal.traffic.submit': 'Lưu traffic',
          'modal.traffic.autofetch': 'Thử tự động lấy',
          'label.videoPostDate': 'Ngày đăng video',
          'label.videoLinkRequired': 'Link video *',
          'label.views': 'Lượt xem',
          'label.likes': 'Lượt thích',
          'label.comments': 'Bình luận',
          'label.saves': 'Lưu',
          'label.shares': 'Chia sẻ',
          'modal.import.title': 'Nhập KOC',
          'modal.import.hint': 'Tải lên CSV (không có ảnh), thứ tự: tên,tài khoản,kênh,liên hệ,ghi chú',
          'modal.import.choose': 'Chọn CSV',
          'modal.import.template': 'Tải mẫu',
          'modal.import.submit': 'Bắt đầu nhập',
          'label.storeNameRequired': 'Tên cửa hàng *',
          'label.address': 'Địa chỉ',
          'label.storePhoto': 'Ảnh cửa hàng',
          'hint.storeImageToData': 'Ảnh sẽ được lưu dạng base64 để hiển thị thẻ',
          'modal.user.title': 'Thêm tài khoản',
          'modal.user.submit': 'Tạo tài khoản',
          'label.userNameRequired': 'Tài khoản *',
          'label.userPasswordRequired': 'Mật khẩu *',
          'filter.allStores': 'Tất cả cửa hàng',
          'source.scheduled': 'Đặt lịch',
          'source.walkin': 'Tự đến',
          'common.na': '—',
          'common.pending': 'Chưa chốt',
          'common.unnamed': 'Chưa đặt tên',
          'common.view': 'Xem',
          'common.edit': 'Sửa',
          'common.delete': 'Xóa',
          'common.close': 'Đóng',
          'common.cancel': 'Hủy',
          'common.noData': 'Chưa có dữ liệu',
          'common.and': ' và ',
          'overview.bookings7d.empty': 'Không có lịch hẹn trong 7 ngày tới',
          'image.previewTitle': 'Xem ảnh',
          'influencers.profileLinkLabel': 'ID KOC:',
          'influencers.auditReportLabel': 'Báo cáo audit:',
          'influencers.commentDetailLabel': 'Chi tiết bình luận:',
          'influencers.avatarPreview': 'Xem ảnh',
          'influencers.avatarDelete': 'Xóa ảnh',
          'influencers.contactMissing': 'Chưa có thông tin liên hệ',
          'influencers.duplicateBase': 'KOC này đã tồn tại theo {fields}, không cần thêm',
          'influencers.duplicateMatched': ' (Đã có: {name}{handle})',
          'field.displayName': 'tên',
          'field.handle': 'tài khoản',
          'dataDetail.title': 'Chi tiết dữ liệu',
          'dataDetail.fileSelect': 'Chọn tệp',
          'dataDetail.search.placeholder': 'Tìm kiếm (tất cả trường)',
          'dataDetail.meta': 'Tệp: {file} · {count} dòng',
          'influencerFiles.count': 'Đã tải lên {n} tệp',
          'influencerFiles.empty': 'Chưa có tệp (có thể chọn nhiều)',
          'influencerFiles.pending': 'Chờ tải lên',
          'influencerFiles.confirmDelete': 'Xác nhận xóa tệp này?',
          'influencerFiles.deleted': 'Đã xóa tệp',
          'influencerFiles.uploaded': 'Đã tải lên tệp',
          'influencerFiles.uploading': 'Đang tải lên tệp đính kèm...',
          'upload.tooLarge': 'Tệp quá lớn, vui lòng chọn tệp nhỏ hơn {max}MB',
          'upload.readFailed': 'Đọc tệp thất bại',
          'upload.parseFailed': 'Không phân tích được tệp, vui lòng kiểm tra CSV/TSV/JSON',
          'upload.excelNotSupported': 'Chưa hỗ trợ file Excel, hãy lưu thành CSV hoặc xuất JSON',
          'stores.empty': 'Chưa có cửa hàng',
          'stores.addressMissing': 'Chưa có địa chỉ',
          'bookings.empty': 'Chưa có lịch hẹn',
          'bookings.trafficAdd': 'Nhập traffic',
          'traffic.none': 'Chưa nhập',
          'traffic.summary': '{views} lượt xem · {date}',
          'users.empty': 'Chưa có tài khoản',
          'users.resetPassword': 'Đặt lại mật khẩu',
          'pager.total': 'Tổng {count}',
          'pager.goto': 'Đi tới',
          'pager.page': 'trang',
          'pager.perPage': '{n}/trang',
          'pager.prev': '‹',
          'pager.next': '›',
          'confirm.deleteInfluencer': 'Xác nhận xóa KOC này? Nếu có lịch hẹn/traffic liên quan sẽ không xóa được.',
          'confirm.deleteBooking': 'Xác nhận xóa lịch hẹn này? Traffic liên quan cũng sẽ bị xóa.',
          'confirm.deleteStore': 'Xác nhận xóa cửa hàng này? Nếu có lịch hẹn liên quan sẽ không xóa được.',
          'toast.influencerDeleted': 'Đã xóa KOC',
          'toast.bookingDeleted': 'Đã xóa lịch hẹn',
          'toast.storeDeleted': 'Đã xóa cửa hàng'
        }
      };

      function t(key, vars) {
        const lang = state.lang === 'vi' ? 'vi' : 'zh';
        const raw = (i18n[lang] && i18n[lang][key]) || (i18n.zh && i18n.zh[key]) || key;
        return String(raw).replace(/\{(\w+)\}/g, (_, k) => (vars && vars[k] !== undefined ? String(vars[k]) : ''));
      }

      function makePlaceholderSvg(width, height, label, radius = 16) {
        const w = Math.max(1, Number(width) || 40);
        const h = Math.max(1, Number(height) || 40);
        const r = Math.max(0, Math.min(Number(radius) || 0, Math.min(w, h) / 2));
        const fontSize = Math.max(10, Math.round(Math.min(w, h) * 0.42));
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#f2f6ff"/><stop offset="1" stop-color="#d9e5ff"/></linearGradient></defs><rect width="${w}" height="${h}" rx="${r}" fill="url(#g)"/><text x="50%" y="54%" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Arial" font-size="${fontSize}" fill="#0b2e68" opacity="0.9">${escapeHtml(label || '+')}</text></svg>`;
        return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
      }

      const PLACEHOLDER = {
        avatar40: makePlaceholderSvg(40, 40, '+', 14),
        avatar96: makePlaceholderSvg(96, 96, '+', 22),
        store56: makePlaceholderSvg(56, 56, '+', 18)
      };

      function setLang(lang) {
        const next = lang === 'vi' ? 'vi' : 'zh';
        state.lang = next;
        localStorage.setItem('booking_lang', next);
        document.title = t('app.title');
        applyI18n();
        refreshUiText();
        const sel1 = document.getElementById('langSelect');
        const sel2 = document.getElementById('langSelectLogin');
        if (sel1) sel1.value = next;
        if (sel2) sel2.value = next;
      }

      function applyI18n(root = document) {
        root.querySelectorAll('[data-i18n]').forEach(el => {
          el.textContent = t(el.getAttribute('data-i18n'));
        });
        root.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          el.setAttribute('placeholder', t(el.getAttribute('data-i18n-placeholder')));
        });
        root.querySelectorAll('[data-i18n-title]').forEach(el => {
          el.setAttribute('title', t(el.getAttribute('data-i18n-title')));
        });
      }

      function translateRuntimeMessage(message) {
        const msg = String(message || '').trim();
        if (!msg) return msg;
        if (state.lang !== 'vi') return msg;
        const exact = {
          '请重新登录': 'Vui lòng đăng nhập lại',
          '登录已失效': 'Phiên đăng nhập đã hết hạn',
          '未登录': 'Chưa đăng nhập',
          '账号或密码错误': 'Sai tài khoản hoặc mật khẩu',
          '登录失败，请稍后重试': 'Đăng nhập thất bại, vui lòng thử lại sau',
          'JSON 格式错误': 'Sai định dạng JSON',
          '请选择门店': 'Vui lòng chọn cửa hàng',
          '请选择达人': 'Vui lòng chọn KOC',
          '请填写到访日期': 'Vui lòng chọn ngày đến',
          '未找到预约': 'Không tìm thấy lịch hẹn',
          '未找到门店': 'Không tìm thấy cửa hàng',
          '未找到达人': 'Không tìm thấy KOC',
          '未找到流量记录': 'Không tìm thấy bản ghi traffic'
        };
        if (exact[msg]) return exact[msg];
        const m = msg.match(/^视频链接返回状态\s+(\d+)/);
        if (m) return `Link video trả về trạng thái ${m[1]}`;
        if (msg === '无法访问该视频链接') return 'Không thể truy cập link video';
        if (msg === '请提供视频链接') return 'Vui lòng nhập link video';
        if (msg === '请求体过大') return 'Yêu cầu quá lớn';
        if (msg === '请求体不是有效的 JSON') return 'Nội dung gửi lên không phải JSON hợp lệ';
        return msg;
      }

      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = translateRuntimeMessage(message);
        toast.classList.add('show');
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(() => toast.classList.remove('show'), 2400);
      }

      function refreshUiText() {
        updatePageTitle();
        if (state.token) {
          renderOverview();
          renderInfluencers();
          renderStoreCards();
          renderBookingTable();
          renderUserTable();
          updateStoreSelects();
          updateInfluencerSelect();
        }
      }

      function setToken(token) {
        state.token = token;
        if (token) {
          localStorage.setItem('booking_token', token);
        } else {
          localStorage.removeItem('booking_token');
          localStorage.removeItem('booking_user');
          state.user = null;
          document.getElementById('sidebarUser').textContent = '';
        }
      }

      async function apiFetch(url, options = {}) {
        const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
        if (state.token) {
          headers['Authorization'] = `Bearer ${state.token}`;
        }
        const res = await fetch(url, Object.assign({}, options, { headers }));
        if (res.status === 401) {
          setToken('');
          showLogin();
          throw new Error('请重新登录');
        }
        if (!res.ok) {
          const contentType = String(res.headers.get('content-type') || '').toLowerCase();
          if (contentType.includes('application/json')) {
            try {
              const data = await res.json();
              throw new Error(data?.error || data?.message || JSON.stringify(data));
            } catch (error) {
              if (error instanceof Error && error.message) throw error;
            }
          }
          const text = await res.text();
          throw new Error(text || '请求失败');
        }
        return res.json();
      }

      function showLogin() {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('appShell').classList.add('hidden');
      }

      function showApp() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appShell').classList.remove('hidden');
      }

      function switchView(viewId) {
        state.currentView = viewId;
        document.querySelectorAll('.menu button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === viewId);
        });
        document.querySelectorAll('.view').forEach(section => {
          section.classList.toggle('active', section.id === `${viewId}View`);
        });
        updatePageTitle();
        if (viewId === 'influencers') {
          renderInfluencers();
        }
      }

      function getInfluencerPageSize() {
        const container = document.getElementById('influencerCards');
        const rows = Number(state.infRowsPerPage || 2);
        if (!container || !container.isConnected) return Math.max(1, rows * 6);
        const template = getComputedStyle(container).gridTemplateColumns || '';
        if (!template || template === 'none') return Math.max(1, rows * 6);
        const columns = template.split(' ').filter(Boolean).length;
        return Math.max(1, columns * rows);
      }

      function clampNumber(value, min, max) {
        const num = Number(value);
        if (!Number.isFinite(num)) return min;
        return Math.min(max, Math.max(min, num));
      }

      function buildPagerTokens(currentPage, totalPages) {
        if (totalPages <= 7) {
          return Array.from({ length: totalPages }, (_, i) => i + 1);
        }
        if (currentPage <= 4) {
          return [1, 2, 3, 4, 5, 6, '…', totalPages];
        }
        if (currentPage >= totalPages - 3) {
          return [1, '…', totalPages - 5, totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        }
        return [1, '…', currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2, '…', totalPages];
      }

      function renderPager(containerId, config) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const totalItems = Math.max(0, Number(config.totalItems) || 0);
        const pageSize = Math.max(1, Number(config.pageSize) || 10);
        const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
        const currentPage = clampNumber(config.page, 1, totalPages);

        const pageSizeSelect = config.pageSizeSelect;
        const sizeHtml = pageSizeSelect
          ? `
              <select class="pager-size-select" data-page-size>
                ${(pageSizeSelect.options || [])
                  .map(
                    opt =>
                      `<option value="${String(opt.value)}" ${String(opt.value) === String(pageSizeSelect.value) ? 'selected' : ''}>${opt.label}</option>`
                  )
                  .join('')}
              </select>
            `
          : '';

        const tokens = buildPagerTokens(currentPage, totalPages);
        const pagesHtml = tokens
          .map(token => {
            if (token === '…') return `<span class="pager-ellipsis">…</span>`;
            const pageNum = Number(token);
            const active = pageNum === currentPage ? 'active' : '';
            return `<button class="pager-page ${active}" type="button" data-page-num="${pageNum}">${pageNum}</button>`;
          })
          .join('');

        container.innerHTML = `
          <div class="pager-left">
            <span class="cell-sub">${t('pager.total', { count: totalItems })}</span>
            ${sizeHtml}
          </div>
          <div class="pager-pages">
            <button class="pager-nav" type="button" data-page-nav="prev" ${currentPage === 1 ? 'disabled' : ''}>${t('pager.prev')}</button>
            ${pagesHtml}
            <button class="pager-nav" type="button" data-page-nav="next" ${currentPage === totalPages ? 'disabled' : ''}>${t('pager.next')}</button>
          </div>
          <div class="pager-jump">
            <span class="cell-sub">${t('pager.goto')}</span>
            <input class="pager-jump-input" type="number" min="1" max="${totalPages}" value="${currentPage}" data-page-jump />
            <span class="cell-sub">${t('pager.page')}</span>
          </div>
        `;

        const onPageChange = typeof config.onPageChange === 'function' ? config.onPageChange : null;
        const onPageSizeChange = pageSizeSelect && typeof pageSizeSelect.onChange === 'function' ? pageSizeSelect.onChange : null;

        container.querySelectorAll('[data-page-num]').forEach(btn => {
          btn.addEventListener('click', () => {
            if (!onPageChange) return;
            const nextPage = clampNumber(btn.getAttribute('data-page-num'), 1, totalPages);
            if (nextPage === currentPage) return;
            onPageChange(nextPage, { totalPages, pageSize, totalItems });
          });
        });
        container.querySelectorAll('[data-page-nav]').forEach(btn => {
          btn.addEventListener('click', () => {
            if (!onPageChange) return;
            const dir = btn.getAttribute('data-page-nav');
            if (dir === 'prev' && currentPage > 1) return onPageChange(currentPage - 1, { totalPages, pageSize, totalItems });
            if (dir === 'next' && currentPage < totalPages) return onPageChange(currentPage + 1, { totalPages, pageSize, totalItems });
          });
        });
        const jumpInput = container.querySelector('[data-page-jump]');
        if (jumpInput && onPageChange) {
          const go = () => {
            const nextPage = clampNumber(jumpInput.value, 1, totalPages);
            if (nextPage === currentPage) return;
            onPageChange(nextPage, { totalPages, pageSize, totalItems });
          };
          jumpInput.addEventListener('keydown', event => {
            if (event.key === 'Enter') {
              event.preventDefault();
              go();
            }
          });
          jumpInput.addEventListener('blur', go);
        }
        const sizeSelect = container.querySelector('[data-page-size]');
        if (sizeSelect && onPageSizeChange) {
          sizeSelect.addEventListener('change', () => {
            const nextValue = sizeSelect.value;
            onPageSizeChange(nextValue, { totalPages, pageSize, totalItems });
          });
        }
      }

      function dataUrlFromFile(file) {
        return new Promise((resolve, reject) => {
          if (!file) return resolve('');
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function textFromFile(file) {
        const read = encoding =>
          new Promise((resolve, reject) => {
            if (!file) return resolve('');
            const reader = new FileReader();
            reader.onload = () => resolve(String(reader.result || ''));
            reader.onerror = () => reject(new Error(t('upload.readFailed')));
            if (encoding) {
              reader.readAsText(file, encoding);
            } else {
              reader.readAsText(file);
            }
          });

        return new Promise(async (resolve, reject) => {
          if (!file) return resolve('');
          try {
            const primary = await read();
            const nulCount = (primary.match(/\u0000/g) || []).length;
            if (nulCount >= 8) {
              try {
                const utf16 = await read('utf-16le');
                return resolve(String(utf16 || ''));
              } catch (error) {
                return resolve(String(primary || '').replace(/\u0000/g, ''));
              }
            }
            resolve(primary);
          } catch (error) {
            reject(error);
          }
        });
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function parseDelimitedTable(text, delimiter) {
        const rows = [];
        let row = [];
        let field = '';
        let inQuotes = false;

        const pushField = () => {
          row.push(field);
          field = '';
        };
        const pushRow = () => {
          const trimmed = row.map(cell => (cell ?? '').replace(/\u0000/g, ''));
          if (trimmed.some(cell => String(cell).trim() !== '')) {
            rows.push(trimmed);
          }
          row = [];
        };

        const str = String(text || '').replace(/^\uFEFF/, '');
        for (let i = 0; i < str.length; i++) {
          const ch = str[i];
          if (ch === '\r') continue;
          if (ch === '"') {
            if (inQuotes && str[i + 1] === '"') {
              field += '"';
              i++;
              continue;
            }
            inQuotes = !inQuotes;
            continue;
          }
          if (!inQuotes && ch === delimiter) {
            pushField();
            continue;
          }
          if (!inQuotes && ch === '\n') {
            pushField();
            pushRow();
            continue;
          }
          field += ch;
        }
        pushField();
        pushRow();

        if (!rows.length) return { columns: [], rows: [] };
        const header = rows.shift().map(h => String(h || '').trim());
        const columns = header.map((h, idx) => h || `col_${idx + 1}`);
        const dataRows = rows.map(cells => {
          const obj = {};
          columns.forEach((col, idx) => {
            obj[col] = cells[idx] ?? '';
          });
          return obj;
        });
        return { columns, rows: dataRows };
      }

      function normalizeJsonRows(input) {
        if (Array.isArray(input)) return input;
        if (!input || typeof input !== 'object') return null;
        for (const key of ['rows', 'data', 'items', 'list', 'result']) {
          if (Array.isArray(input[key])) return input[key];
        }
        for (const key of Object.keys(input)) {
          if (Array.isArray(input[key])) return input[key];
        }
        return null;
      }

      function parseDetailText(text, fileName = '') {
        const raw = String(text || '').replace(/^\uFEFF/, '').trim();
        if (!raw) return { columns: [], rows: [] };
        const looksJson = raw.startsWith('{') || raw.startsWith('[');

        if (looksJson || String(fileName || '').toLowerCase().endsWith('.json')) {
          let parsed;
          try {
            parsed = JSON.parse(raw);
          } catch (error) {
            throw new Error(t('upload.parseFailed'));
          }
          const rows = normalizeJsonRows(parsed);
          if (!rows || !rows.length) return { columns: [], rows: [] };
          if (rows.every(item => item && typeof item === 'object' && !Array.isArray(item))) {
            const columns = Array.from(
              new Set(
                rows
                  .flatMap(obj => Object.keys(obj || {}))
                  .map(k => String(k || '').trim())
                  .filter(Boolean)
              )
            );
            return { columns, rows: rows.map(obj => Object.fromEntries(columns.map(col => [col, obj?.[col] ?? '']))) };
          }
          if (rows.every(item => Array.isArray(item))) {
            const maxLen = Math.max(...rows.map(arr => arr.length));
            const columns = Array.from({ length: maxLen }, (_, idx) => `col_${idx + 1}`);
            return {
              columns,
              rows: rows.map(arr => Object.fromEntries(columns.map((col, idx) => [col, arr[idx] ?? ''])))
            };
          }
          const columns = ['value'];
          return { columns, rows: rows.map(item => ({ value: item ?? '' })) };
        }

        const firstLine = raw.split('\n')[0] || '';
        const commaCount = (firstLine.match(/,/g) || []).length;
        const tabCount = (firstLine.match(/\t/g) || []).length;
        const semiCount = (firstLine.match(/;/g) || []).length;
        const delimiter = tabCount >= commaCount && tabCount >= semiCount ? '\t' : semiCount > commaCount ? ';' : ',';
        return parseDelimitedTable(raw, delimiter);
      }

      function renderDataDetailModal() {
        const { columns, rows, search, page, pageSize, fileName } = state.dataDetail;
        const searchKey = String(search || '').trim().toLowerCase();
        const filtered = !searchKey
          ? rows
          : rows.filter(row => {
              const blob = columns
                .map(col => row?.[col])
                .filter(v => v !== null && v !== undefined)
                .join(' ')
                .toLowerCase();
              return blob.includes(searchKey);
            });

        const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
        const currentPage = clampNumber(page, 1, totalPages);
        if (currentPage !== page) state.dataDetail.page = currentPage;

        document.getElementById('dataDetailMeta').textContent = t('dataDetail.meta', {
          file: fileName || t('common.na'),
          count: filtered.length
        });

        const head = document.getElementById('dataDetailHead');
        const body = document.getElementById('dataDetailBody');
        if (!columns.length) {
          head.innerHTML = '';
          body.innerHTML = `<tr><td class="hint">${t('common.noData')}</td></tr>`;
        } else if (!filtered.length) {
          head.innerHTML = `<tr>${columns.map(col => `<th>${escapeHtml(col)}</th>`).join('')}</tr>`;
          body.innerHTML = `<tr><td colspan="${columns.length}" class="hint">${t('common.noData')}</td></tr>`;
        } else {
          const start = (currentPage - 1) * pageSize;
          const pageRows = filtered.slice(start, start + pageSize);
          head.innerHTML = `<tr>${columns.map(col => `<th>${escapeHtml(col)}</th>`).join('')}</tr>`;
          body.innerHTML = pageRows
            .map(
              row =>
                `<tr>${columns.map(col => `<td>${escapeHtml(row?.[col] ?? '')}</td>`).join('')}</tr>`
            )
            .join('');
        }

        renderPager('dataDetailPager', {
          totalItems: filtered.length,
          page: currentPage,
          pageSize,
          pageSizeSelect: {
            value: String(pageSize),
            options: [10, 20, 50, 100].map(n => ({ value: String(n), label: t('pager.perPage', { n }) })),
            onChange: nextValue => {
              state.dataDetail.pageSize = Math.max(1, Number(nextValue) || 20);
              state.dataDetail.page = 1;
              renderDataDetailModal();
            }
          },
          onPageChange: nextPage => {
            state.dataDetail.page = nextPage;
            renderDataDetailModal();
          }
        });
      }

      function openDataDetailModal({ title, fileName, text }) {
        const parsed = parseDetailText(text, fileName);
        state.dataDetail.title = title || t('dataDetail.title');
        state.dataDetail.fileName = fileName || '';
        state.dataDetail.columns = parsed.columns || [];
        state.dataDetail.rows = parsed.rows || [];
        state.dataDetail.search = '';
        state.dataDetail.page = 1;
        state.dataDetail.fileOptions = [];
        state.dataDetail.selectedFileId = '';
        state.dataDetail.sourceInfluencerId = '';
        state.dataDetail.sourceKind = '';
        const fileRow = document.getElementById('dataDetailFileRow');
        if (fileRow) fileRow.classList.add('hidden');
        const titleEl = document.getElementById('dataDetailTitle');
        titleEl.removeAttribute('data-i18n');
        titleEl.textContent = state.dataDetail.title;
        const searchEl = document.getElementById('dataDetailSearch');
        searchEl.value = '';
        openModal('dataDetail');
        renderDataDetailModal();
      }

      function renderDataDetailFilePicker() {
        const row = document.getElementById('dataDetailFileRow');
        const selectEl = document.getElementById('dataDetailFileSelect');
        if (!row || !selectEl) return;
        const options = Array.isArray(state.dataDetail.fileOptions) ? state.dataDetail.fileOptions : [];
        if (options.length <= 1) {
          row.classList.add('hidden');
          selectEl.innerHTML = '';
          return;
        }
        row.classList.remove('hidden');
        selectEl.innerHTML = options
          .map(opt => {
            const id = String(opt.id || '');
            const fileName = String(opt.fileName || '');
            const createdAt = opt.createdAt ? new Date(opt.createdAt).toLocaleString() : '';
            const label = [fileName, createdAt].filter(Boolean).join(' · ') || id;
            return `<option value="${escapeHtml(id)}" ${id === state.dataDetail.selectedFileId ? 'selected' : ''}>${escapeHtml(label)}</option>`;
          })
          .join('');
      }

      async function loadDataDetailFromInfluencerFile() {
        const influencerId = state.dataDetail.sourceInfluencerId;
        const fileId = state.dataDetail.selectedFileId;
        if (!influencerId || !fileId) return;
        const res = await apiFetch(
          `/api/influencers/${encodeURIComponent(influencerId)}/files/${encodeURIComponent(fileId)}`
        );
        const file = res?.file;
        if (!file) throw new Error(t('common.noData'));
        const parsed = parseDetailText(file.fileText || '', file.fileName || '');
        state.dataDetail.fileName = file.fileName || '';
        state.dataDetail.columns = parsed.columns || [];
        state.dataDetail.rows = parsed.rows || [];
        state.dataDetail.search = '';
        state.dataDetail.page = 1;
        const searchEl = document.getElementById('dataDetailSearch');
        if (searchEl) searchEl.value = '';
        renderDataDetailModal();
      }

      async function openInfluencerFileViewer(options = {}) {
        const influencerId = String(options.influencerId || '').trim();
        const kind = String(options.kind || '').trim();
        if (!influencerId || !['audit', 'comment'].includes(kind)) return;
        const title = String(options.title || '').trim() || t('dataDetail.title');
        const preferredFileId = String(options.fileId || '').trim();
        const listRes = await apiFetch(
          `/api/influencers/${encodeURIComponent(influencerId)}/files?kind=${encodeURIComponent(kind)}`
        );
        const files = Array.isArray(listRes?.files) ? listRes.files : [];
        if (!files.length) {
          showToast(t('common.noData'));
          return;
        }
        const chosen = files.find(f => String(f.id) === preferredFileId) || files[0];
        state.dataDetail.title = title;
        state.dataDetail.fileOptions = files;
        state.dataDetail.selectedFileId = String(chosen.id || '');
        state.dataDetail.sourceInfluencerId = influencerId;
        state.dataDetail.sourceKind = kind;
        const titleEl = document.getElementById('dataDetailTitle');
        titleEl.removeAttribute('data-i18n');
        titleEl.textContent = state.dataDetail.title;
        renderDataDetailFilePicker();
        openModal('dataDetail');
        await loadDataDetailFromInfluencerFile();
      }

      function renderOverview() {
        const now = new Date();
        const today = [
          now.getFullYear(),
          String(now.getMonth() + 1).padStart(2, '0'),
          String(now.getDate()).padStart(2, '0')
        ].join('-');
        const end = new Date(now);
        end.setDate(end.getDate() + 6);
        const endDate = [
          end.getFullYear(),
          String(end.getMonth() + 1).padStart(2, '0'),
          String(end.getDate()).padStart(2, '0')
        ].join('-');
        const upcomingBookings = state.bookings
          .filter(item => item.visitDate && item.visitDate >= today && item.visitDate <= endDate)
          .sort((a, b) => {
            if (a.visitDate !== b.visitDate) return String(a.visitDate).localeCompare(String(b.visitDate));
            return String(a.visitWindow || '').localeCompare(String(b.visitWindow || ''));
          });
        const tbody = document.getElementById('overviewTodayBookings');
        if (!upcomingBookings.length) {
          tbody.innerHTML = `<tr><td colspan="4" class="hint">${t('overview.bookings7d.empty')}</td></tr>`;
        } else {
          tbody.innerHTML = upcomingBookings
            .map(booking => {
              const influencer = state.influencers.find(item => item.id === booking.influencerId);
              const avatar = influencer?.avatarData || PLACEHOLDER.avatar40;
              const displayName = influencer?.displayName || booking.creatorName || t('common.unnamed');
              const handle = influencer?.handle || booking.handle || '';
              const contactMethod = booking.contactMethod || influencer?.contactMethod || '';
              const contactInfo = booking.contactInfo || influencer?.contactInfo || '';
              const contact =
                contactMethod || contactInfo ? [contactMethod, contactInfo].filter(Boolean).join(' ') : t('common.na');
              const visitTime = [booking.visitDate, booking.visitWindow].filter(Boolean).join(' ') || t('common.na');
              return `
              <tr>
                <td>
                  <div class="overview-person">
                    <img class="overview-avatar clickable" src="${avatar}" alt="${displayName}" data-preview-src="${avatar}" data-preview-alt="${displayName}" />
                    <div>
                      <div>${displayName}</div>
                      <div class="cell-sub">${handle || t('common.na')}</div>
                    </div>
                  </div>
                </td>
                <td>${contact}</td>
                <td>${booking.storeName || t('common.na')}</td>
                <td>${visitTime}</td>
              </tr>
            `;
            })
            .join('');
        }
        if (!state.overview) return;
        const storeSelect = document.getElementById('overviewTrafficStoreFilter');
        const keywordInput = document.getElementById('overviewTrafficKeyword');
        if (storeSelect) {
          const selected = state.overviewTrafficFilters?.store || 'all';
          const storeNames = [...new Set((state.stores || []).map(item => item.name).filter(Boolean))];
          storeSelect.innerHTML = [`<option value="all">${t('filter.allStores')}</option>`]
            .concat(storeNames.map(name => `<option value="${name}">${name}</option>`))
            .join('');
          storeSelect.value = selected;
        }
        if (keywordInput) {
          const q = state.overviewTrafficFilters?.q || '';
          if (keywordInput.value !== q) keywordInput.value = q;
        }

        const trafficStore = String(state.overviewTrafficFilters?.store || 'all');
        const trafficKeyword = String(state.overviewTrafficFilters?.q || '').trim().toLowerCase();
        const trafficList = [...(state.overview.latestTraffic || [])].filter(log => {
          if (trafficStore && trafficStore !== 'all' && String(log.storeName || '') !== trafficStore) {
            return false;
          }
          if (trafficKeyword) {
            const name = String(log.influencerName || '').toLowerCase();
            if (!name.includes(trafficKeyword)) return false;
          }
          return true;
        });
        const sort = state.overviewTrafficSort || { field: 'views', dir: 'desc' };
        const sortedTraffic = [...trafficList].sort((a, b) => {
          const dir = sort.dir === 'asc' ? 1 : -1;
          if (sort.field === 'postDate') {
            const aDate = String(a.postDate || '').trim();
            const bDate = String(b.postDate || '').trim();
            const aMissing = !aDate || aDate === '—';
            const bMissing = !bDate || bDate === '—';
            if (aMissing && bMissing) return (Number(b.metrics?.views || 0) - Number(a.metrics?.views || 0)) || 0;
            if (aMissing) return 1;
            if (bMissing) return -1;
            const cmp = aDate.localeCompare(bDate);
            if (cmp) return cmp * dir;
            const viewCmp = Number(b.metrics?.views || 0) - Number(a.metrics?.views || 0);
            if (viewCmp) return viewCmp;
            return String(a.influencerName || '').localeCompare(String(b.influencerName || ''));
          }
          const aViews = Number(a.metrics?.views || 0);
          const bViews = Number(b.metrics?.views || 0);
          if (aViews !== bViews) return (aViews - bViews) * dir;
          return String(a.influencerName || '').localeCompare(String(b.influencerName || ''));
        });

        const subtitleEl = document.getElementById('overviewTrafficSubtitle');
        if (subtitleEl) {
          if (sort.field === 'postDate') {
            subtitleEl.textContent = t(sort.dir === 'asc' ? 'overview.traffic.subtitle.postDateAsc' : 'overview.traffic.subtitle.postDateDesc');
          } else {
            subtitleEl.textContent = t('overview.traffic.subtitle.views');
          }
        }
        const sortBtn = document.getElementById('overviewTrafficPostDateSort');
        if (sortBtn) {
          const active = sort.field === 'postDate';
          sortBtn.classList.toggle('active', active);
          sortBtn.classList.toggle('asc', active && sort.dir === 'asc');
          sortBtn.classList.toggle('desc', active && sort.dir === 'desc');
          const nextTitle = !active
            ? t('sort.toAsc')
            : sort.dir === 'asc'
              ? t('sort.toDesc')
              : t('sort.clear');
          sortBtn.setAttribute('title', nextTitle);
          sortBtn.setAttribute('aria-label', nextTitle);
        }
        const totalPages = Math.max(1, Math.ceil(trafficList.length / state.overviewTrafficPageSize));
        if (state.overviewTrafficPage > totalPages) {
          state.overviewTrafficPage = totalPages;
        }
        const start = (state.overviewTrafficPage - 1) * state.overviewTrafficPageSize;
        const pageList = sortedTraffic.slice(start, start + state.overviewTrafficPageSize);
        document.getElementById('overviewTraffic').innerHTML = pageList
          .map(
            log => `
          <tr>
            <td>${log.influencerName}</td>
            <td>${log.storeName || t('common.na')}</td>
            <td>${log.videoLink ? `<a href="${log.videoLink}" target="_blank" rel="noopener">${t('common.view')}</a>` : t('common.na')}</td>
            <td>${log.postDate || t('common.na')}</td>
            <td>${log.metrics?.views || 0}</td>
            <td>${log.metrics?.likes || 0}</td>
            <td>${log.metrics?.comments || 0}</td>
            <td>${log.metrics?.saves || 0}</td>
            <td>${log.metrics?.shares || 0}</td>
            <td>${new Date(log.capturedAt).toLocaleString()}</td>
          </tr>
        `
          )
          .join('');
        renderPager('overviewTrafficPager', {
          totalItems: trafficList.length,
          page: state.overviewTrafficPage,
          pageSize: state.overviewTrafficPageSize,
          pageSizeSelect: {
            value: String(state.overviewTrafficPageSize),
            options: [10, 20, 50].map(n => ({ value: String(n), label: t('pager.perPage', { n }) })),
            onChange: nextValue => {
              state.overviewTrafficPageSize = Math.max(1, Number(nextValue) || 10);
              state.overviewTrafficPage = 1;
              renderOverview();
            }
          },
          onPageChange: nextPage => {
            state.overviewTrafficPage = nextPage;
            renderOverview();
          }
        });
      }

      function updatePageTitle() {
        const map = {
          overview: t('menu.overview'),
          influencers: t('menu.influencers'),
          bookings: t('menu.bookings'),
          users: t('menu.users'),
          stores: t('menu.stores')
        };
        document.getElementById('pageTitle').textContent = map[state.currentView] || t('app.title');
      }

      function renderInfluencers() {
        const keyword = document.getElementById('influencerSearch').value.trim().toLowerCase();
        const list = keyword
          ? state.influencers.filter(item =>
              [item.displayName, item.handle].some(text => (text || '').toLowerCase().includes(keyword))
            )
          : state.influencers;
        let sortedList = [...list];
        const pinnedId = state.lastCreatedInfluencerId || '';
        if (pinnedId) {
          const idx = sortedList.findIndex(item => item.id === pinnedId);
          if (idx >= 0) {
            const [created] = sortedList.splice(idx, 1);
            sortedList.unshift(created);
          }
        }
        if (state._justCreatedInfluencerId) {
          const idx = sortedList.findIndex(item => item.id === state._justCreatedInfluencerId);
          if (idx >= 0) {
            const [created] = sortedList.splice(idx, 1);
            sortedList.unshift(created);
            state.infPage = 1;
          }
          state._justCreatedInfluencerId = '';
        }
        const container = document.getElementById('influencerCards');
        const pager = document.getElementById('infPagination');
        if (!sortedList.length) {
          container.innerHTML = `<div class="hint">${t('common.noData')}</div>`;
          pager.innerHTML = '';
          return;
        }
        const pageSize = getInfluencerPageSize();
        const totalPages = Math.max(1, Math.ceil(sortedList.length / pageSize));
        if (state.infPage > totalPages) {
          state.infPage = totalPages;
        }
        const start = (state.infPage - 1) * pageSize;
        const pageList = sortedList.slice(start, start + pageSize);
        container.innerHTML = pageList
          .map(
            inf => `
          <article class="inf-card influencer-card">
            <div class="inf-actions">
              <button class="icon-btn" data-edit-inf="${inf.id}" title="${t('common.edit')}">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                  <path d="M13.5 6.5l4 4L7 21H3v-4l10.5-10.5z"></path>
                  <path d="M12 7l3-3 4 4-3 3"></path>
                </svg>
              </button>
              <button class="icon-btn danger-btn" data-delete-inf="${inf.id}" title="${t('common.delete')}">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                  <path d="M6 7h12"></path>
                  <path d="M10 11v6"></path>
                  <path d="M14 11v6"></path>
                  <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12"></path>
                  <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
            <img class="inf-avatar inf-avatar-large" src="${inf.avatarData || PLACEHOLDER.avatar96}" alt="avatar" />
            <div class="inf-meta">
              <h4>${inf.displayName}</h4>
              <p class="cell-sub">${inf.handle || t('common.na')}</p>
              <p class="cell-sub">
                ${t('influencers.profileLinkLabel')}
                ${
                  inf.profileLink
                    ? `<a href="${inf.profileLink}" target="_blank" rel="noreferrer">${inf.profileLink}</a>`
                    : t('common.na')
                }
              </p>
              <p class="cell-sub">
                ${t('influencers.auditReportLabel')}
                ${
                  Number(inf.auditFileCount || 0) > 0
                    ? `<a href="#" data-view-audit="${inf.id}">${t('common.view')}</a>`
                    : t('common.na')
                }
              </p>
              <p class="cell-sub">
                ${t('influencers.commentDetailLabel')}
                ${
                  Number(inf.commentFileCount || 0) > 0
                    ? `<a href="#" data-view-comment="${inf.id}">${t('common.view')}</a>`
                    : t('common.na')
                }
              </p>
              <p class="cell-sub">${[inf.contactMethod, inf.contactInfo].filter(Boolean).join(' ') || t('influencers.contactMissing')}</p>
              ${inf.notes ? `<p class="cell-sub">${inf.notes}</p>` : ''}
            </div>
          </article>
        `
          )
          .join('');
        container.querySelectorAll('[data-edit-inf]').forEach(btn => {
          btn.addEventListener('click', () => startEditInfluencer(btn.dataset.editInf));
        });
        container.querySelectorAll('[data-delete-inf]').forEach(btn => {
          btn.addEventListener('click', () => deleteInfluencer(btn.dataset.deleteInf));
        });
        container.querySelectorAll('[data-view-audit]').forEach(link => {
          link.addEventListener('click', async event => {
            event.preventDefault();
            const id = link.getAttribute('data-view-audit') || '';
            const inf = state.influencers.find(item => item.id === id);
            if (!inf || Number(inf.auditFileCount || 0) <= 0) return;
            try {
              await openInfluencerFileViewer({
                influencerId: inf.id,
                kind: 'audit',
                title: `${inf.displayName || t('common.unnamed')} · ${t('influencers.auditReportLabel').replace(/[:：]\\s*$/, '')}`
              });
            } catch (error) {
              showToast(error.message || t('upload.parseFailed'));
            }
          });
        });
        container.querySelectorAll('[data-view-comment]').forEach(link => {
          link.addEventListener('click', async event => {
            event.preventDefault();
            const id = link.getAttribute('data-view-comment') || '';
            const inf = state.influencers.find(item => item.id === id);
            if (!inf || Number(inf.commentFileCount || 0) <= 0) return;
            try {
              await openInfluencerFileViewer({
                influencerId: inf.id,
                kind: 'comment',
                title: `${inf.displayName || t('common.unnamed')} · ${t('influencers.commentDetailLabel').replace(/[:：]\\s*$/, '')}`
              });
            } catch (error) {
              showToast(error.message || t('upload.parseFailed'));
            }
          });
        });
        const computedColumns = (() => {
          const template = getComputedStyle(container).gridTemplateColumns || '';
          if (!template || template === 'none') return 6;
          return template.split(' ').filter(Boolean).length || 6;
        })();
        const rowCandidates = [2, 3, 4, 5, 6];
        const currentRows = Math.max(1, Number(state.infRowsPerPage || 2));
        const rows = Array.from(new Set([currentRows, ...rowCandidates])).sort((a, b) => a - b);
        renderPager('infPagination', {
          totalItems: sortedList.length,
          page: state.infPage,
          pageSize,
          pageSizeSelect: {
            value: String(currentRows),
            options: rows.map(r => ({ value: String(r), label: t('pager.perPage', { n: computedColumns * r }) })),
            onChange: nextValue => {
              state.infRowsPerPage = Math.max(1, Number(nextValue) || 2);
              state.infPage = 1;
              renderInfluencers();
            }
          },
          onPageChange: nextPage => {
            state.infPage = nextPage;
            renderInfluencers();
          }
        });
      }

      function renderStoreCards() {
        const container = document.getElementById('storeCards');
        if (!state.stores.length) {
          container.innerHTML = `<div class="hint">${t('stores.empty')}</div>`;
          return;
        }
        container.innerHTML = state.stores
          .map(
            store => `
          <article class="inf-card store-card">
            <div class="inf-actions">
              <button class="icon-btn" data-edit-store="${store.id}" title="${t('common.edit')}">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                  <path d="M13.5 6.5l4 4L7 21H3v-4l10.5-10.5z"></path>
                  <path d="M12 7l3-3 4 4-3 3"></path>
                </svg>
              </button>
              <button class="icon-btn danger-btn" data-delete-store="${store.id}" title="${t('common.delete')}">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                  <path d="M6 7h12"></path>
                  <path d="M10 11v6"></path>
                  <path d="M14 11v6"></path>
                  <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12"></path>
                  <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
            <img class="inf-avatar" src="${store.imageData || PLACEHOLDER.store56}" alt="store" />
            <div>
              <h4>${store.name}</h4>
              <p>${store.address || t('stores.addressMissing')}</p>
            </div>
          </article>
        `
          )
          .join('');
        container.querySelectorAll('[data-edit-store]').forEach(btn => {
          btn.addEventListener('click', () => startEditStore(btn.dataset.editStore));
        });
        container.querySelectorAll('[data-delete-store]').forEach(btn => {
          btn.addEventListener('click', () => deleteStore(btn.dataset.deleteStore));
        });
      }

      function renderBookingTable() {
        const tbody = document.getElementById('bookingTable');
        if (!state.bookings.length) {
          tbody.innerHTML = `<tr><td colspan="8" class="hint">${t('bookings.empty')}</td></tr>`;
          return;
        }
        const filtered = state.bookings.filter(record => {
          const keyword = state.filters.q.toLowerCase();
          if (keyword) {
            const blob = [record.creatorName, record.storeName, record.visitDate]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            if (!blob.includes(keyword)) return false;
          }
          if (state.filters.store && state.filters.store !== 'all' && record.storeId !== state.filters.store) {
            return false;
          }
          if (state.filters.date && record.visitDate !== state.filters.date) {
            return false;
          }
          return true;
        });
        const totalPages = Math.max(1, Math.ceil(filtered.length / state.bookingPageSize));
        if (state.bookingPage > totalPages) {
          state.bookingPage = totalPages;
        }
        const start = (state.bookingPage - 1) * state.bookingPageSize;
        const pageList = filtered.slice(start, start + state.bookingPageSize);
        tbody.innerHTML = pageList
          .map(record => {
            const tag =
              record.sourceType === '自来'
                ? `<span class="tag walkin">${t('source.walkin')}</span>`
                : `<span class="tag schedule">${t('source.scheduled')}</span>`;
            const latest = state.trafficLogs.find(log => log.bookingId === record.id);
            const trafficText = latest
              ? t('traffic.summary', {
                  views: latest.metrics?.views || 0,
                  date: new Date(latest.capturedAt).toLocaleDateString()
                })
                : t('traffic.none');
              return `
            <tr>
              <td>${record.creatorName}</td>
              <td>${record.storeName}</td>
              <td>${tag}</td>
              <td>${record.visitDate || t('common.pending')} ${record.visitWindow || ''}</td>
              <td>${record.serviceDetail || record.videoRights || t('common.na')}</td>
              <td>${record.budgetMillionVND || 0}</td>
              <td>${trafficText}</td>
              <td>
                <button class="ghost-btn" data-edit-booking="${record.id}">${t('common.edit')}</button>
                <button class="ghost-btn" data-traffic="${record.id}">${t('bookings.trafficAdd')}</button>
                <button class="ghost-btn danger-btn" data-delete-booking="${record.id}">${t('common.delete')}</button>
              </td>
            </tr>
          `;
          })
          .join('');
        tbody.querySelectorAll('[data-edit-booking]').forEach(btn => {
          btn.addEventListener('click', () => openBookingModal(btn.dataset.editBooking));
        });
        tbody.querySelectorAll('[data-traffic]').forEach(btn => {
          btn.addEventListener('click', () => openTrafficModal(btn.dataset.traffic));
        });
        tbody.querySelectorAll('[data-delete-booking]').forEach(btn => {
          btn.addEventListener('click', () => deleteBooking(btn.dataset.deleteBooking));
        });
        renderPager('bookingPagination', {
          totalItems: filtered.length,
          page: state.bookingPage,
          pageSize: state.bookingPageSize,
          pageSizeSelect: {
            value: String(state.bookingPageSize),
            options: [10, 20, 50, 100].map(n => ({ value: String(n), label: t('pager.perPage', { n }) })),
            onChange: nextValue => {
              state.bookingPageSize = Math.max(1, Number(nextValue) || 10);
              state.bookingPage = 1;
              renderBookingTable();
            }
          },
          onPageChange: nextPage => {
            state.bookingPage = nextPage;
            renderBookingTable();
          }
        });
      }

      function renderUserTable() {
        const tbody = document.getElementById('userTable');
        if (!state.users?.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="hint">${t('users.empty')}</td></tr>`;
          return;
        }
        tbody.innerHTML = state.users
          .map(
            user => `
          <tr>
            <td>${user.username}</td>
            <td>${user.role || 'admin'}</td>
            <td><button class="ghost-btn" data-reset-user="${user.id}">${t('users.resetPassword')}</button></td>
          </tr>
        `
          )
          .join('');
        tbody.querySelectorAll('[data-reset-user]').forEach(btn => {
          btn.addEventListener('click', () => resetUserPassword(btn.dataset.resetUser));
        });
      }

      function updateStoreSelects() {
        const storeFilter = document.getElementById('bookingStoreFilter');
        const modalStore = document.getElementById('modalStore');
        const prevFilterValue = storeFilter.value;
        const prevModalValue = modalStore.value;
        const options = [`<option value="all">${t('filter.allStores')}</option>`]
          .concat(state.stores.map(store => `<option value="${store.id}">${store.name}</option>`))
          .join('');
        storeFilter.innerHTML = options;
        modalStore.innerHTML = state.stores
          .map(store => `<option value="${store.id}">${store.name}</option>`)
          .join('');
        if (prevFilterValue) storeFilter.value = prevFilterValue;
        if (prevModalValue) modalStore.value = prevModalValue;
      }

      function updateInfluencerSelect() {
        const list = document.getElementById('modalInfluencerList');
        const sorted = [...state.influencers].sort((a, b) =>
          (a.displayName || '').localeCompare(b.displayName || '', undefined, { sensitivity: 'base' })
        );
        // datalist 精确匹配回填用：label -> id
        state._influencerLookup = new Map();
        // 兼容用户只输入 handle / displayName 的场景
        state._influencerLookupHandle = new Map(); // handle(去掉@) -> id
        state._influencerLookupName = new Map(); // displayName(仅唯一时) -> id
        list.innerHTML = sorted
          .map(inf => {
            const handle = inf.handle ? ` ${inf.handle}` : '';
            const value = `${inf.displayName || t('common.unnamed')}${handle}`.trim();
            state._influencerLookup.set(value.toLowerCase(), inf.id);
            const nameKey = String(inf.displayName || '').trim().toLowerCase();
            if (nameKey) {
              if (state._influencerLookupName.has(nameKey)) {
                state._influencerLookupName.set(nameKey, '');
              } else {
                state._influencerLookupName.set(nameKey, inf.id);
              }
            }
            const handleKey = String(inf.handle || '')
              .trim()
              .toLowerCase()
              .replace(/^@+/, '');
            if (handleKey) state._influencerLookupHandle.set(handleKey, inf.id);
            return `<option value="${value}"></option>`;
          })
          .join('');
      }

      function resolveInfluencerIdFromSearch(rawText) {
        const raw = String(rawText || '').trim();
        if (!raw) return '';
        const key = raw.toLowerCase();
        const byLabel = state._influencerLookup?.get(key);
        if (byLabel) return byLabel;
        const handleKey = key.replace(/^@+/, '');
        const byHandle = state._influencerLookupHandle?.get(handleKey);
        if (byHandle) return byHandle;
        const byName = state._influencerLookupName?.get(key);
        if (byName) return byName;
        return '';
      }

      function setBookingInfluencerAlert(message) {
        const alertEl = document.getElementById('modalInfluencerAlert');
        const searchEl = document.getElementById('modalInfluencerSearch');
        if (!alertEl || !searchEl) return;
        const text = String(message || '').trim();
        if (text) {
          alertEl.textContent = text;
          alertEl.classList.remove('hidden');
          searchEl.classList.add('input-error');
        } else {
          alertEl.textContent = '';
          alertEl.classList.add('hidden');
          searchEl.classList.remove('input-error');
        }
      }

      function normalizeInfluencerHandleForCompare(handleText) {
        return String(handleText || '')
          .trim()
          .toLowerCase()
          .replace(/^@+/, '');
      }

      function normalizeInfluencerNameForCompare(nameText) {
        return String(nameText || '')
          .trim()
          .toLowerCase();
      }

      function setInfluencerDuplicateAlert(message, options = {}) {
        const alertEl = document.getElementById('infDuplicateAlert');
        const nameEl = document.getElementById('infName');
        const handleEl = document.getElementById('infHandle');
        if (!alertEl || !nameEl || !handleEl) return;
        const text = String(message || '').trim();
        if (text) {
          alertEl.textContent = text;
          alertEl.classList.remove('hidden');
        } else {
          alertEl.textContent = '';
          alertEl.classList.add('hidden');
        }
        nameEl.classList.toggle('input-error', Boolean(options.highlightName) && Boolean(text));
        handleEl.classList.toggle('input-error', Boolean(options.highlightHandle) && Boolean(text));
      }

      function syncBookingInfluencerFromSearch(options = {}) {
        const searchEl = document.getElementById('modalInfluencerSearch');
        const hiddenEl = document.getElementById('modalInfluencer');
        if (!searchEl || !hiddenEl) return;
        const raw = String(searchEl.value || '').trim();
        const id = resolveInfluencerIdFromSearch(raw);
        hiddenEl.value = id || '';
        if (!raw || id) return setBookingInfluencerAlert('');
        if (options.toastOnMiss) return setBookingInfluencerAlert(t('booking.influencerNotFound'));
        return setBookingInfluencerAlert('');
      }

      function startEditStore(id) {
        openStoreModal(id);
      }

      function startEditInfluencer(id) {
        openInfluencerModal(id);
      }

      async function deleteInfluencer(id) {
        if (!id) return;
        const confirmed = confirm(t('confirm.deleteInfluencer'));
        if (!confirmed) return;
        try {
          await apiFetch(`/api/influencers/${id}`, { method: 'DELETE' });
          showToast(t('toast.influencerDeleted'));
          await loadAllData();
        } catch (error) {
          showToast(error.message);
        }
      }

      async function deleteBooking(id) {
        if (!id) return;
        const confirmed = confirm(t('confirm.deleteBooking'));
        if (!confirmed) return;
        try {
          await apiFetch(`/api/bookings/${id}`, { method: 'DELETE' });
          showToast(t('toast.bookingDeleted'));
          await loadAllData();
        } catch (error) {
          showToast(error.message);
        }
      }

      async function deleteStore(id) {
        if (!id) return;
        const confirmed = confirm(t('confirm.deleteStore'));
        if (!confirmed) return;
        try {
          await apiFetch(`/api/stores/${id}`, { method: 'DELETE' });
          showToast(t('toast.storeDeleted'));
          await loadAllData();
        } catch (error) {
          showToast(error.message);
        }
      }

      function openModal(which) {
        document.getElementById('modalBackdrop').classList.remove('hidden');
        document.getElementById('bookingModal').classList.toggle('hidden', which !== 'booking');
        document.getElementById('trafficModal').classList.toggle('hidden', which !== 'traffic');
        document.getElementById('influencerModal').classList.toggle('hidden', which !== 'influencer');
        document.getElementById('infImportModal').classList.toggle('hidden', which !== 'infImport');
        document.getElementById('storeModal').classList.toggle('hidden', which !== 'store');
        document.getElementById('userModal').classList.toggle('hidden', which !== 'user');
        document.getElementById('dataDetailModal').classList.toggle('hidden', which !== 'dataDetail');
      }

      function closeModals() {
        document.getElementById('modalBackdrop').classList.add('hidden');
        ['bookingModal', 'trafficModal', 'influencerModal', 'infImportModal', 'storeModal', 'userModal', 'dataDetailModal'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add('hidden');
        });
      }

      function openBookingModal(id = '') {
        if (typeof id !== 'string') id = '';
        document.getElementById('bookingForm').reset();
        updateStoreSelects();
        updateInfluencerSelect();
        document.getElementById('modalInfluencer').value = '';
        document.getElementById('modalInfluencerSearch').value = '';
        setBookingInfluencerAlert('');
        if (id) {
          state.editingBookingId = id;
          const record = state.bookings.find(item => item.id === id);
          if (record) {
            document.getElementById('modalStore').value = record.storeId || '';
            const inf = state.influencers.find(item => item.id === record.influencerId);
            document.getElementById('modalInfluencer').value = record.influencerId || '';
            if (inf) {
              const label = `${inf.displayName || t('common.unnamed')}${inf.handle ? ` ${inf.handle}` : ''}`.trim();
              document.getElementById('modalInfluencerSearch').value = label;
            } else if (record.creatorName || record.handle) {
              document.getElementById('modalInfluencerSearch').value = `${record.creatorName || ''} ${record.handle || ''}`.trim();
            }
            document.getElementById('modalSource').value = record.sourceType || '预约';
            document.getElementById('modalVisitDate').value = record.visitDate || '';
            document.getElementById('modalVisitWindow').value = record.visitWindow || '';
            document.getElementById('modalService').value = record.serviceDetail || '';
            document.getElementById('modalRights').value = record.videoRights || '';
            document.getElementById('modalBudget').value = record.budgetMillionVND ?? '';
            document.getElementById('modalPostDate').value = record.postDate || '';
            document.getElementById('modalNotes').value = record.notes || '';
          }
          document.getElementById('bookingModalTitle').textContent = t('modal.booking.editTitle');
          document.getElementById('bookingSubmit').textContent = t('modal.booking.save');
        } else {
          state.editingBookingId = '';
          document.getElementById('bookingModalTitle').textContent = t('modal.booking.addTitle');
          document.getElementById('bookingSubmit').textContent = t('modal.booking.submit');
        }
        openModal('booking');
      }

      function openStoreModal(id = '') {
        document.getElementById('storeForm').reset();
        document.getElementById('storeImageData').value = '';
        if (id) {
          state.editingStoreId = id;
          const store = state.stores.find(item => item.id === id);
          if (store) {
            document.getElementById('storeName').value = store.name;
            document.getElementById('storeAddress').value = store.address || '';
            document.getElementById('storeImageData').value = store.imageData || '';
            document.getElementById('storeModalTitle').textContent = t('modal.store.editTitle');
            document.getElementById('storeSubmit').textContent = t('modal.store.save');
          }
        } else {
          state.editingStoreId = '';
          document.getElementById('storeModalTitle').textContent = t('modal.store.addTitle');
          document.getElementById('storeSubmit').textContent = t('modal.store.submit');
        }
        openModal('store');
      }

      function formatIsoToLocal(iso) {
        if (!iso) return '';
        try {
          return new Date(iso).toLocaleString();
        } catch (error) {
          return String(iso || '');
        }
      }

      function resetInfluencerFileState() {
        state.influencerFiles = { audit: [], comment: [] };
        state.pendingInfluencerFiles = { audit: [], comment: [] };
        document.getElementById('infAuditReportMeta').textContent = '';
        document.getElementById('infCommentDetailMeta').textContent = '';
        document.getElementById('infAuditReportMeta').classList.remove('error');
        document.getElementById('infCommentDetailMeta').classList.remove('error');
        document.getElementById('infAuditReportList').innerHTML = '';
        document.getElementById('infCommentDetailList').innerHTML = '';
      }

      function setInfluencerAvatarPreview(src, altText) {
        const img = document.getElementById('infAvatarPreviewImg');
        const btn = document.getElementById('infAvatarClearBtn');
        if (!img || !btn) return;
        const value = String(src || '');
        img.src = value || PLACEHOLDER.avatar96;
        img.alt = altText || '';
        btn.classList.toggle('hidden', !value);
        img.classList.toggle('clickable', Boolean(value));
        btn.setAttribute('aria-label', t('influencers.avatarDelete'));
        btn.setAttribute('title', t('influencers.avatarDelete'));
      }

      function updateInfluencerCounts(influencerId, kind, nextCount) {
        const inf = state.influencers.find(item => item.id === influencerId);
        if (!inf) return;
        if (kind === 'audit') inf.auditFileCount = Math.max(0, Number(nextCount) || 0);
        if (kind === 'comment') inf.commentFileCount = Math.max(0, Number(nextCount) || 0);
      }

      function renderInfluencerFileList(kind) {
        const isEditing = Boolean(state.editingInfluencerId);
        const listEl = document.getElementById(kind === 'audit' ? 'infAuditReportList' : 'infCommentDetailList');
        const metaEl = document.getElementById(kind === 'audit' ? 'infAuditReportMeta' : 'infCommentDetailMeta');
        const items = isEditing ? state.influencerFiles[kind] || [] : state.pendingInfluencerFiles[kind] || [];
        const countText =
          items.length > 0 ? t('influencerFiles.count', { n: items.length }) : t('influencerFiles.empty');
        metaEl.textContent = countText;
        metaEl.classList.remove('error');
        if (!items.length) {
          listEl.innerHTML = '';
          return;
        }
        listEl.innerHTML = items
          .map(item => {
            const id = String(item.id || '');
            const fileName = String(item.fileName || '');
            const createdAt = item.createdAt ? formatIsoToLocal(item.createdAt) : '';
            const sub = [createdAt, item.pending ? t('influencerFiles.pending') : ''].filter(Boolean).join(' · ');
            return `
              <div class="file-item" data-inf-file-view="${escapeHtml(id)}" data-inf-file-kind="${escapeHtml(kind)}">
                <div class="file-name" title="${escapeHtml(fileName)}">${escapeHtml(fileName || t('common.unnamed'))}</div>
                ${sub ? `<div class="file-sub">${escapeHtml(sub)}</div>` : ''}
                <button
                  class="file-close"
                  type="button"
                  data-inf-file-delete="${escapeHtml(id)}"
                  aria-label="${escapeHtml(t('common.delete'))}"
                  title="${escapeHtml(t('common.delete'))}"
                >×</button>
              </div>
            `;
          })
          .join('');

        listEl.querySelectorAll('[data-inf-file-view]').forEach(card => {
          card.addEventListener('click', async event => {
            if (event.target && event.target.closest && event.target.closest('[data-inf-file-delete]')) return;
            const fileId = card.getAttribute('data-inf-file-view') || '';
            if (!fileId) return;
            try {
              if (!state.editingInfluencerId) {
                const pending = (state.pendingInfluencerFiles[kind] || []).find(f => f.id === fileId);
                if (!pending) return;
                openDataDetailModal({
                  title: pending.fileName || t('dataDetail.title'),
                  fileName: pending.fileName || '',
                  text: pending.fileText || ''
                });
                return;
              }
              const inf = state.influencers.find(item => item.id === state.editingInfluencerId);
              const name = inf?.displayName || t('common.unnamed');
              const labelKey = kind === 'audit' ? 'influencers.auditReportLabel' : 'influencers.commentDetailLabel';
              await openInfluencerFileViewer({
                influencerId: state.editingInfluencerId,
                kind,
                fileId,
                title: `${name} · ${t(labelKey).replace(/[:：]\\s*$/, '')}`
              });
            } catch (error) {
              showToast(error.message || t('upload.parseFailed'));
            }
          });
        });
        listEl.querySelectorAll('[data-inf-file-delete]').forEach(btn => {
          btn.addEventListener('click', async event => {
            event.preventDefault();
            event.stopPropagation();
            const fileId = btn.getAttribute('data-inf-file-delete') || '';
            if (!fileId) return;
            const confirmed = confirm(t('influencerFiles.confirmDelete'));
            if (!confirmed) return;
            try {
              if (!state.editingInfluencerId) {
                state.pendingInfluencerFiles[kind] = (state.pendingInfluencerFiles[kind] || []).filter(f => f.id !== fileId);
                renderInfluencerFileList(kind);
                return;
              }
              await apiFetch(
                `/api/influencers/${encodeURIComponent(state.editingInfluencerId)}/files/${encodeURIComponent(fileId)}`,
                { method: 'DELETE' }
              );
              state.influencerFiles[kind] = (state.influencerFiles[kind] || []).filter(f => f.id !== fileId);
              updateInfluencerCounts(state.editingInfluencerId, kind, (state.influencerFiles[kind] || []).length);
              renderInfluencerFileList(kind);
              renderInfluencers();
              showToast(t('influencerFiles.deleted'));
            } catch (error) {
              showToast(error.message);
            }
          });
        });
      }

      async function loadInfluencerFilesForModal(influencerId) {
        if (!influencerId) return;
        try {
          const [auditRes, commentRes] = await Promise.all([
            apiFetch(`/api/influencers/${encodeURIComponent(influencerId)}/files?kind=audit`),
            apiFetch(`/api/influencers/${encodeURIComponent(influencerId)}/files?kind=comment`)
          ]);
          state.influencerFiles.audit = Array.isArray(auditRes?.files) ? auditRes.files : [];
          state.influencerFiles.comment = Array.isArray(commentRes?.files) ? commentRes.files : [];
          updateInfluencerCounts(influencerId, 'audit', state.influencerFiles.audit.length);
          updateInfluencerCounts(influencerId, 'comment', state.influencerFiles.comment.length);
        } catch (error) {
          console.warn(error);
        } finally {
          renderInfluencerFileList('audit');
          renderInfluencerFileList('comment');
        }
      }

      function openInfluencerModal(id = '') {
        document.getElementById('influencerForm').reset();
        document.getElementById('infId').value = id;
        document.getElementById('infAvatarData').value = '';
        document.getElementById('infAuditReportFile').value = '';
        document.getElementById('infCommentDetailFile').value = '';
        resetInfluencerFileState();
        setInfluencerDuplicateAlert('');
        if (id) {
          state.editingInfluencerId = id;
          const inf = state.influencers.find(item => item.id === id);
          if (inf) {
            document.getElementById('infName').value = inf.displayName;
            document.getElementById('infHandle').value = inf.handle || '';
            document.getElementById('infProfileLink').value = inf.profileLink || '';
            document.getElementById('infAvatarData').value = inf.avatarData || '';
            setInfluencerAvatarPreview(inf.avatarData || '', inf.displayName || '');
            document.getElementById('infContactMethod').value = inf.contactMethod || '';
            document.getElementById('infContactInfo').value = inf.contactInfo || '';
            document.getElementById('infNotes').value = inf.notes || '';
            document.getElementById('infModalTitle').textContent = t('modal.influencer.editTitle');
            document.getElementById('infSubmit').textContent = t('modal.influencer.save');
          }
        } else {
          state.editingInfluencerId = '';
          setInfluencerAvatarPreview('', '');
          document.getElementById('infModalTitle').textContent = t('modal.influencer.addTitle');
          document.getElementById('infSubmit').textContent = t('modal.influencer.submit');
        }
        openModal('influencer');
        if (id) {
          loadInfluencerFilesForModal(id);
        } else {
          renderInfluencerFileList('audit');
          renderInfluencerFileList('comment');
        }
      }

      function openInfImportModal() {
        document.getElementById('infImportForm').reset();
        openModal('infImport');
      }

      function openTrafficModal(bookingId) {
        document.getElementById('trafficForm').reset();
        document.getElementById('trafficBookingId').value = bookingId;
        document.getElementById('trafficId').value = '';
        const existing = state.trafficLogs.find(log => log.bookingId === bookingId);
        if (existing) {
          document.getElementById('trafficId').value = existing.id;
          document.getElementById('trafficPostDate').value = existing.postDate || '';
          document.getElementById('trafficVideo').value = existing.videoLink || '';
          document.getElementById('trafficViews').value = existing.metrics?.views ?? '';
          document.getElementById('trafficLikes').value = existing.metrics?.likes ?? '';
          document.getElementById('trafficComments').value = existing.metrics?.comments ?? '';
          document.getElementById('trafficSaves').value = existing.metrics?.saves ?? '';
          document.getElementById('trafficShares').value = existing.metrics?.shares ?? '';
          document.getElementById('trafficNote').value = existing.note || '';
        }
        openModal('traffic');
      }

      async function resetUserPassword(id) {
        const password = prompt('请输入新密码');
        if (!password) return;
        await apiFetch(`/api/users/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ password })
        });
        showToast('密码已更新');
      }

      async function loadAllData(options = {}) {
        const preservePages = Boolean(options.preservePages);
        const prevPages = {
          infPage: state.infPage,
          bookingPage: state.bookingPage,
          overviewTrafficPage: state.overviewTrafficPage
        };
        const [storesRes, infRes, bookingsRes, trafficRes, overviewRes, usersRes] = await Promise.all([
          apiFetch('/api/stores'),
          apiFetch('/api/influencers'),
          apiFetch('/api/bookings'),
          apiFetch('/api/traffic'),
          apiFetch('/api/overview'),
          apiFetch('/api/users')
        ]);
        state.stores = storesRes.stores || [];
        state.influencers = infRes.influencers || [];
        state.bookings = bookingsRes.records || [];
        state.trafficLogs = trafficRes.logs || [];
        state.overview = overviewRes.data;
        state.users = usersRes.users || [];
        if (preservePages) {
          state.infPage = Math.max(1, Number(prevPages.infPage) || 1);
          state.bookingPage = Math.max(1, Number(prevPages.bookingPage) || 1);
          state.overviewTrafficPage = Math.max(1, Number(prevPages.overviewTrafficPage) || 1);
        } else {
          state.infPage = 1;
          state.bookingPage = 1;
          state.overviewTrafficPage = 1;
        }
        document.getElementById('welcomeHint').textContent = '';
        updatePageTitle();
        renderOverview();
        renderInfluencers();
        renderStoreCards();
        renderBookingTable();
        renderUserTable();
        updateStoreSelects();
        updateInfluencerSelect();
      }

      async function bootstrap() {
        applyI18n();
        document.title = t('app.title');
        const LAST_CREATED_TTL_MS = 1000 * 60 * 60 * 24 * 7;
        if (state.lastCreatedInfluencerAt && Date.now() - state.lastCreatedInfluencerAt > LAST_CREATED_TTL_MS) {
          state.lastCreatedInfluencerId = '';
          state.lastCreatedInfluencerAt = 0;
          localStorage.removeItem('booking_lastCreatedInfluencerId');
          localStorage.removeItem('booking_lastCreatedInfluencerAt');
        }
        const langSelect = document.getElementById('langSelect');
        const langSelectLogin = document.getElementById('langSelectLogin');
        if (langSelect) langSelect.value = state.lang;
        if (langSelectLogin) langSelectLogin.value = state.lang;
        if (langSelect) langSelect.addEventListener('change', event => setLang(event.target.value));
        if (langSelectLogin) langSelectLogin.addEventListener('change', event => setLang(event.target.value));

        const templateCsv = '达人昵称,账号,联系渠道,联系方式,备注\n示例达人,@demo,Zalo,0123456789,备注可留空';
        document.getElementById('infTemplateLink').setAttribute(
          'href',
          'data:text/csv;charset=utf-8,' + encodeURIComponent(templateCsv)
        );
        document.querySelectorAll('.menu button').forEach(btn => {
          btn.addEventListener('click', () => switchView(btn.dataset.view));
        });
        document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', closeModals));
        document.getElementById('modalBackdrop').addEventListener('click', event => {
          if (event.target && event.target.id === 'modalBackdrop') {
            closeModals();
          }
        });
        document.getElementById('openBookingModal').addEventListener('click', () => openBookingModal());
        const modalInfluencerSearchEl = document.getElementById('modalInfluencerSearch');
        modalInfluencerSearchEl.addEventListener('input', () => syncBookingInfluencerFromSearch());
        modalInfluencerSearchEl.addEventListener('change', () => syncBookingInfluencerFromSearch());
        modalInfluencerSearchEl.addEventListener('blur', () => syncBookingInfluencerFromSearch({ toastOnMiss: true }));
        const imagePreviewBackdrop = document.getElementById('imagePreviewBackdrop');
        const imagePreviewImg = document.getElementById('imagePreviewImg');
        const imagePreviewTitle = document.getElementById('imagePreviewTitle');
        function openImagePreview(src, title) {
          imagePreviewImg.src = src || '';
          imagePreviewImg.alt = title || t('image.previewTitle');
          imagePreviewTitle.textContent = title ? `${t('image.previewTitle')} · ${title}` : t('image.previewTitle');
          imagePreviewBackdrop.classList.remove('hidden');
          imagePreviewBackdrop.setAttribute('aria-hidden', 'false');
        }
        function closeImagePreview() {
          imagePreviewBackdrop.classList.add('hidden');
          imagePreviewBackdrop.setAttribute('aria-hidden', 'true');
          imagePreviewImg.src = '';
          imagePreviewImg.alt = '';
        }
        document.getElementById('closeImagePreview').addEventListener('click', closeImagePreview);
        imagePreviewBackdrop.addEventListener('click', event => {
          if (event.target === imagePreviewBackdrop) closeImagePreview();
        });
        document.addEventListener('keydown', event => {
          if (event.key === 'Escape' && !imagePreviewBackdrop.classList.contains('hidden')) {
            closeImagePreview();
          }
          if (event.key === 'Escape' && !document.getElementById('modalBackdrop').classList.contains('hidden')) {
            closeModals();
          }
        });
        document.getElementById('overviewTodayBookings').addEventListener('click', event => {
          const target = event.target;
          const img = target?.closest?.('[data-preview-src]');
          if (!img) return;
          const src = img.getAttribute('data-preview-src') || img.getAttribute('src') || '';
          const title = img.getAttribute('data-preview-alt') || img.getAttribute('alt') || '';
          if (!src) return;
          openImagePreview(src, title);
        });
        document.getElementById('overviewTrafficStoreFilter').addEventListener('change', event => {
          state.overviewTrafficFilters.store = event.target.value;
          state.overviewTrafficPage = 1;
          renderOverview();
        });
        document.getElementById('overviewTrafficKeyword').addEventListener('input', event => {
          state.overviewTrafficFilters.q = event.target.value;
          state.overviewTrafficPage = 1;
          renderOverview();
        });
        const postDateSortBtn = document.getElementById('overviewTrafficPostDateSort');
        if (postDateSortBtn) {
          postDateSortBtn.addEventListener('click', () => {
            const current = state.overviewTrafficSort || { field: 'views', dir: 'desc' };
            if (current.field !== 'postDate') {
              state.overviewTrafficSort = { field: 'postDate', dir: 'asc' };
            } else {
              if (current.dir === 'asc') {
                state.overviewTrafficSort = { field: 'postDate', dir: 'desc' };
              } else {
                state.overviewTrafficSort = { field: 'views', dir: 'desc' };
              }
            }
            state.overviewTrafficPage = 1;
            renderOverview();
          });
        }
        document.getElementById('bookingKeyword').addEventListener('input', event => {
          state.filters.q = event.target.value;
          state.bookingPage = 1;
          renderBookingTable();
        });
        document.getElementById('bookingStoreFilter').addEventListener('change', event => {
          state.filters.store = event.target.value;
          state.bookingPage = 1;
          renderBookingTable();
        });
        document.getElementById('bookingDate').addEventListener('change', event => {
          state.filters.date = event.target.value;
          state.bookingPage = 1;
          renderBookingTable();
        });
        document.getElementById('influencerSearch').addEventListener('input', () => {
          state.infPage = 1;
          renderInfluencers();
        });
        let infResizeTimer = null;
        window.addEventListener('resize', () => {
          if (state.currentView !== 'influencers') return;
          clearTimeout(infResizeTimer);
          infResizeTimer = setTimeout(() => {
            state.infPage = 1;
            renderInfluencers();
          }, 120);
        });
        document.getElementById('openInfModal').addEventListener('click', () => openInfluencerModal());
        document.getElementById('openInfImport').addEventListener('click', openInfImportModal);
        document.getElementById('openStoreModal').addEventListener('click', () => openStoreModal());
        document.getElementById('openUserModal').addEventListener('click', () => {
          document.getElementById('userForm').reset();
          openModal('user');
        });
        document.getElementById('infPhoto').addEventListener('change', async event => {
          const file = event.target.files?.[0];
          const dataUrl = file ? await dataUrlFromFile(file) : '';
          document.getElementById('infAvatarData').value = dataUrl;
          setInfluencerAvatarPreview(dataUrl, document.getElementById('infName').value || '');
        });
        document.getElementById('infAvatarClearBtn').addEventListener('click', () => {
          document.getElementById('infAvatarData').value = '';
          document.getElementById('infPhoto').value = '';
          setInfluencerAvatarPreview('', '');
        });
        document.getElementById('infAvatarPreviewImg').addEventListener('click', event => {
          const src = String(document.getElementById('infAvatarData').value || '').trim();
          if (!src) return;
          openImagePreview(src, document.getElementById('infName').value || '');
        });
        const DETAIL_MAX_BYTES = 5 * 1024 * 1024;
        function makeTmpId() {
          return `tmp-${Date.now()}-${Math.random().toString(16).slice(2)}`;
        }
        async function handleInfluencerFilesSelected(kind, fileList, inputEl) {
          const metaEl = document.getElementById(kind === 'audit' ? 'infAuditReportMeta' : 'infCommentDetailMeta');
          metaEl.classList.remove('error');
          const files = Array.from(fileList || []).filter(Boolean);
          if (!files.length) return;
          const maxMB = Math.floor(DETAIL_MAX_BYTES / (1024 * 1024));
          for (const file of files) {
            const lowerName = String(file.name || '').toLowerCase();
            if (lowerName.endsWith('.xlsx') || lowerName.endsWith('.xls')) {
              showToast(t('upload.excelNotSupported'));
              metaEl.textContent = t('upload.excelNotSupported');
              metaEl.classList.add('error');
              continue;
            }
            if (file.size > DETAIL_MAX_BYTES) {
              showToast(t('upload.tooLarge', { max: maxMB }));
              metaEl.textContent = t('upload.tooLarge', { max: maxMB });
              metaEl.classList.add('error');
              continue;
            }
            let text = '';
            try {
              text = await textFromFile(file);
            } catch (error) {
              const msg = error.message || t('upload.readFailed');
              showToast(msg);
              metaEl.textContent = msg;
              metaEl.classList.add('error');
              continue;
            }
            try {
              parseDetailText(text, file.name);
            } catch (error) {
              const msg = error.message || t('upload.parseFailed');
              showToast(msg);
              metaEl.textContent = msg;
              metaEl.classList.add('error');
              continue;
            }

            if (!state.editingInfluencerId) {
              state.pendingInfluencerFiles[kind] = state.pendingInfluencerFiles[kind] || [];
              state.pendingInfluencerFiles[kind].unshift({
                id: makeTmpId(),
                kind,
                fileName: file.name,
                fileText: text,
                createdAt: new Date().toISOString(),
                pending: true
              });
              renderInfluencerFileList(kind);
              continue;
            }

            try {
              const res = await apiFetch(`/api/influencers/${encodeURIComponent(state.editingInfluencerId)}/files`, {
                method: 'POST',
                body: JSON.stringify({ kind, fileName: file.name, fileText: text })
              });
              const saved = res?.file;
              if (saved?.id) {
                state.influencerFiles[kind] = state.influencerFiles[kind] || [];
                state.influencerFiles[kind].unshift(saved);
                updateInfluencerCounts(state.editingInfluencerId, kind, state.influencerFiles[kind].length);
                renderInfluencerFileList(kind);
                renderInfluencers();
                showToast(t('influencerFiles.uploaded'));
              }
            } catch (error) {
              showToast(error.message);
              metaEl.textContent = error.message;
              metaEl.classList.add('error');
            }
          }
          if (inputEl) inputEl.value = '';
        }
        document.getElementById('infAuditReportFile').addEventListener('change', async event => {
          const inputEl = event.target;
          await handleInfluencerFilesSelected('audit', inputEl.files, inputEl);
        });
        document.getElementById('infCommentDetailFile').addEventListener('change', async event => {
          const inputEl = event.target;
          await handleInfluencerFilesSelected('comment', inputEl.files, inputEl);
        });
        document.getElementById('storePhoto').addEventListener('change', async event => {
          const file = event.target.files?.[0];
          document.getElementById('storeImageData').value = file ? await dataUrlFromFile(file) : '';
        });
        document.getElementById('dataDetailSearch').addEventListener('input', event => {
          state.dataDetail.search = event.target.value;
          state.dataDetail.page = 1;
          renderDataDetailModal();
        });
        document.getElementById('dataDetailFileSelect').addEventListener('change', async event => {
          state.dataDetail.selectedFileId = String(event.target.value || '');
          try {
            await loadDataDetailFromInfluencerFile();
          } catch (error) {
            showToast(error.message || t('upload.parseFailed'));
          }
        });
        ['input', 'change'].forEach(evt => {
          document.getElementById('infName').addEventListener(evt, () => setInfluencerDuplicateAlert(''));
          document.getElementById('infHandle').addEventListener(evt, () => setInfluencerDuplicateAlert(''));
        });
        document.getElementById('loginForm').addEventListener('submit', async event => {
          event.preventDefault();
          const formData = new FormData(event.currentTarget);
          try {
            const res = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: formData.get('username'), password: formData.get('password') })
            });
            const data = await res.json();
            if (!res.ok) {
              showToast(data.error || '登录失败');
              return;
            }
            setToken(data.token);
            state.user = data.user;
            localStorage.setItem('booking_user', JSON.stringify(data.user));
            showApp();
            document.getElementById('sidebarUser').textContent = data.user.username;
            await loadAllData();
          } catch (error) {
            showToast(error.message);
          }
        });
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          if (state.token) {
            try {
              await apiFetch('/api/logout', { method: 'POST', body: '{}' });
            } catch (error) {
              console.warn(error);
            }
          }
          setToken('');
          showLogin();
        });
        document.getElementById('openInfModal').addEventListener('click', () => openInfluencerModal());
        document.getElementById('openUserModal').addEventListener('click', () => {
          document.getElementById('userForm').reset();
          openModal('user');
        });
        document.getElementById('influencerForm').addEventListener('submit', async event => {
          event.preventDefault();
          const formEl = event.currentTarget;
          const formData = new FormData(formEl);
          const payload = Object.fromEntries(formData.entries());
          const isCreate = !state.editingInfluencerId;
          if (isCreate) {
            const nameKey = normalizeInfluencerNameForCompare(payload.displayName);
            const handleKey = normalizeInfluencerHandleForCompare(payload.handle);
            const dupByName = nameKey
              ? state.influencers.find(inf => normalizeInfluencerNameForCompare(inf.displayName) === nameKey)
              : null;
            const dupByHandle = handleKey
              ? state.influencers.find(inf => normalizeInfluencerHandleForCompare(inf.handle) === handleKey)
              : null;
            const hasNameDup = Boolean(dupByName);
            const hasHandleDup = Boolean(dupByHandle);
            if (hasNameDup || hasHandleDup) {
              const pieces = [];
              if (hasNameDup) pieces.push(t('field.displayName'));
              if (hasHandleDup) pieces.push(t('field.handle'));
              const matched = dupByHandle || dupByName;
              const matchedText = matched
                ? t('influencers.duplicateMatched', {
                    name: matched.displayName || t('common.unnamed'),
                    handle: matched.handle ? ` ${matched.handle}` : ''
                  })
                : '';
              setInfluencerDuplicateAlert(
                `${t('influencers.duplicateBase', { fields: pieces.join(t('common.and')) })}${matchedText}`,
                {
                highlightName: hasNameDup,
                highlightHandle: hasHandleDup
                }
              );
              if (hasNameDup) {
                document.getElementById('infName').focus();
              } else {
                document.getElementById('infHandle').focus();
              }
              return;
            }
          }
          const method = state.editingInfluencerId ? 'PUT' : 'POST';
          const url = state.editingInfluencerId ? `/api/influencers/${state.editingInfluencerId}` : '/api/influencers';
          const res = await apiFetch(url, { method, body: JSON.stringify(payload) });
          if (isCreate && res?.influencer?.id) {
            const newId = res.influencer.id;
            state._justCreatedInfluencerId = newId;
            state.lastCreatedInfluencerId = newId;
            state.lastCreatedInfluencerAt = Date.now();
            localStorage.setItem('booking_lastCreatedInfluencerId', state.lastCreatedInfluencerId);
            localStorage.setItem('booking_lastCreatedInfluencerAt', String(state.lastCreatedInfluencerAt));
            const pendingAudit = Array.isArray(state.pendingInfluencerFiles.audit) ? state.pendingInfluencerFiles.audit : [];
            const pendingComment = Array.isArray(state.pendingInfluencerFiles.comment)
              ? state.pendingInfluencerFiles.comment
              : [];
            const totalPending = pendingAudit.length + pendingComment.length;
            if (totalPending > 0) {
              showToast(t('influencerFiles.uploading'));
              const batches = [
                ...pendingAudit.map(item => ({ kind: 'audit', item })),
                ...pendingComment.map(item => ({ kind: 'comment', item }))
              ];
              for (const entry of batches) {
                const fileName = entry.item?.fileName || '';
                const fileText = entry.item?.fileText || '';
                if (!fileText) continue;
                try {
                  await apiFetch(`/api/influencers/${encodeURIComponent(newId)}/files`, {
                    method: 'POST',
                    body: JSON.stringify({ kind: entry.kind, fileName, fileText })
                  });
                } catch (error) {
                  showToast(error.message);
                }
              }
              state.pendingInfluencerFiles = { audit: [], comment: [] };
            }
          }
          showToast(state.lang === 'vi' ? 'Đã lưu thông tin KOC' : '达人信息已保存');
          state.editingInfluencerId = '';
          formEl.reset();
          document.getElementById('infSubmit').textContent = t('modal.influencer.submit');
          closeModals();
          await loadAllData({ preservePages: !isCreate });
        });
        document.getElementById('storeForm').addEventListener('submit', async event => {
          event.preventDefault();
          const formEl = event.currentTarget;
          const payload = {
            name: document.getElementById('storeName').value,
            address: document.getElementById('storeAddress').value,
            imageData: document.getElementById('storeImageData').value
          };
          const method = state.editingStoreId ? 'PUT' : 'POST';
          const url = state.editingStoreId ? `/api/stores/${state.editingStoreId}` : '/api/stores';
          await apiFetch(url, { method, body: JSON.stringify(payload) });
          showToast(state.lang === 'vi' ? 'Đã lưu cửa hàng' : '门店已保存');
          state.editingStoreId = '';
          document.getElementById('storeSubmit').textContent = t('modal.store.submit');
          formEl.reset();
          closeModals();
          await loadAllData();
        });
        document.getElementById('storeReset').addEventListener('click', () => {
          state.editingStoreId = '';
          document.getElementById('storeForm').reset();
          document.getElementById('storeSubmit').textContent = t('modal.store.submit');
        });
        document.getElementById('infImportForm').addEventListener('submit', async event => {
          event.preventDefault();
          const file = document.getElementById('infImportFile').files?.[0];
          if (!file) {
            showToast('请选择 CSV 文件');
            return;
          }
          try {
            const text = await file.text();
            const lines = text
              .split(/\r?\n/)
              .map(line => line.trim())
              .filter(Boolean);
            if (!lines.length) {
              showToast('文件为空');
              return;
            }
            // 如果首行包含 header，跳过
            const rows = lines.map(line => line.split(','));
            const header = rows[0]?.[0] || '';
            if (header.toLowerCase().includes('displayname') || header.includes('达人') || header.includes('昵称')) {
              rows.shift();
            }
            let success = 0;
            for (const cols of rows) {
              const [displayName, handle, contactMethod, contactInfo, notes] = cols.map(col => (col || '').trim());
              if (!displayName) continue;
              const payload = { displayName, handle, contactMethod, contactInfo, notes };
              await apiFetch('/api/influencers', { method: 'POST', body: JSON.stringify(payload) });
              success += 1;
            }
            showToast(`导入完成，成功 ${success} 条`);
            closeModals();
            await loadAllData();
          } catch (error) {
            showToast(error.message);
          }
        });
        document.getElementById('bookingForm').addEventListener('submit', async event => {
          event.preventDefault();
          const formEl = event.currentTarget;
          syncBookingInfluencerFromSearch({ toastOnMiss: true });
          const formData = new FormData(formEl);
          const payload = Object.fromEntries(formData.entries());
          const id = state.editingBookingId;
          const url = id ? `/api/bookings/${id}` : '/api/bookings';
          const method = id ? 'PUT' : 'POST';
          if (!payload.influencerId) payload.influencerId = resolveInfluencerIdFromSearch(payload.influencerSearch);
          if (!payload.influencerId) {
            const influencerInput = document.getElementById('modalInfluencerSearch');
            if (influencerInput) influencerInput.focus();
            return;
          }
          delete payload.influencerSearch;
          try {
            await apiFetch(url, { method, body: JSON.stringify(payload) });
            showToast(id ? '预约已更新' : '预约已创建');
            state.editingBookingId = '';
            closeModals();
            formEl.reset();
            await loadAllData({ preservePages: Boolean(id) });
          } catch (error) {
            showToast(error.message);
          }
        });
        document.getElementById('trafficForm').addEventListener('submit', async event => {
          event.preventDefault();
          const formData = new FormData(event.currentTarget);
          const payload = Object.fromEntries(formData.entries());
          ['views', 'likes', 'comments', 'saves', 'shares'].forEach(key => {
            payload[key] = Number(payload[key] || 0);
          });
          const trafficId = payload.trafficId;
          const url = trafficId ? `/api/traffic/${trafficId}` : '/api/traffic';
          const method = trafficId ? 'PUT' : 'POST';
          if (!trafficId) {
            delete payload.trafficId;
          }
          await apiFetch(url, { method, body: JSON.stringify(payload) });
          showToast(trafficId ? '流量已更新' : '流量已登记');
          closeModals();
          await loadAllData({ preservePages: true });
        });
        document.getElementById('autoFetch').addEventListener('click', async () => {
          const videoLink = document.getElementById('trafficVideo').value.trim();
          if (!videoLink) return showToast('请填写视频链接');
          try {
            await autoFillTrafficFromVideoLink(videoLink, { force: true, toastOnSuccess: true });
          } catch (error) {
            showToast(error.message);
          }
        });
        const trafficVideoEl = document.getElementById('trafficVideo');
        let lastAutoFetchedLink = '';
        let autoFetchTimer = null;
        let autoFetchSeq = 0;
        async function autoFillTrafficFromVideoLink(videoLink, options = {}) {
          const { force = false, toastOnSuccess = false } = options;
          const seq = (autoFetchSeq += 1);
          const data = await apiFetch('/api/traffic/fetch', {
            method: 'POST',
            body: JSON.stringify({ videoLink })
          });
          if (seq !== autoFetchSeq) return;
          if (document.getElementById('trafficVideo').value.trim() !== videoLink) return;
          const metrics = data.data?.metrics || {};
          const postDate = data.data?.postDate || data.data?.captionDate || '';
          const postDateEl = document.getElementById('trafficPostDate');
          if (force || !postDateEl.value) {
            postDateEl.value = postDate;
          }
          const viewsEl = document.getElementById('trafficViews');
          const likesEl = document.getElementById('trafficLikes');
          const commentsEl = document.getElementById('trafficComments');
          const savesEl = document.getElementById('trafficSaves');
          const sharesEl = document.getElementById('trafficShares');
          if (force || !viewsEl.value) viewsEl.value = metrics.views || '';
          if (force || !likesEl.value) likesEl.value = metrics.likes || '';
          if (force || !commentsEl.value) commentsEl.value = metrics.comments || '';
          if (force || !savesEl.value) savesEl.value = metrics.saves || '';
          if (force || !sharesEl.value) sharesEl.value = metrics.shares || '';
          if (toastOnSuccess) {
            showToast('已自动填充发布时间与流量数据');
          }
        }
        trafficVideoEl.addEventListener('blur', () => {
          const videoLink = trafficVideoEl.value.trim();
          if (!videoLink) return;
          if (videoLink === lastAutoFetchedLink) return;
          // 仅在发布时间为空时自动抓取，避免覆盖用户手填
          if (document.getElementById('trafficPostDate').value) return;
          lastAutoFetchedLink = videoLink;
          clearTimeout(autoFetchTimer);
          autoFetchTimer = setTimeout(async () => {
            try {
              await autoFillTrafficFromVideoLink(videoLink, { force: false, toastOnSuccess: false });
            } catch (error) {
              showToast('自动抓取失败，可点击“尝试自动抓取”或手动填写');
              console.warn(error);
            }
          }, 200);
        });
        document.getElementById('userForm').addEventListener('submit', async event => {
          event.preventDefault();
          const formEl = event.currentTarget;
          const formData = new FormData(formEl);
          await apiFetch('/api/users', { method: 'POST', body: JSON.stringify(Object.fromEntries(formData.entries())) });
          showToast(state.lang === 'vi' ? 'Đã tạo tài khoản' : '账号已创建');
          formEl.reset();
          closeModals();
          await loadAllData();
        });

        if (state.user) {
          document.getElementById('sidebarUser').textContent = state.user.username || '';
        }

        if (state.token) {
          try {
            showApp();
            await loadAllData();
          } catch (error) {
            showToast(error.message);
            showLogin();
          }
        } else {
          showLogin();
        }
      }

      bootstrap();
    </script>
  </body>
</html>
